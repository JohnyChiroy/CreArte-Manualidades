@{
    ViewData["Title"] = "Reportes | CreArte Manualidades";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/reportes.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<div class="container-fluid">

    <!-- Encabezado -->
    <div class="d-flex align-items-center justify-content-between mb-3">
    </div>

    <div class="row g-4">
        <!-- Mosaico (izquierda) -->
        <div class="col-lg-5">
            <div class="row g-3">
                <div class="col-12">
                    <div class="ua-card-tile" data-url="@Url.Action("Ventas", "Reportes")" data-title="Ventas">
                        <div class="d-flex align-items-center">
                            <div class="ua-tile-icon ua-tile-magenta">
                                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                    <rect x="3" y="11" width="5" height="9" rx="1"></rect>
                                    <rect x="10" y="7" width="5" height="13" rx="1"></rect>
                                    <rect x="17" y="3" width="5" height="17" rx="1"></rect>
                                </svg>
                            </div>
                            <div>
                                <p class="m-0 fw-bold">Ventas</p>
                                <p class="m-0 text-muted">Tendencias, top productos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="ua-card-tile" data-url="@Url.Action("Compras", "Reportes")" data-title="Compras">
                        <div class="d-flex align-items-center">
                            <div class="ua-tile-icon ua-tile-gold">
                                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                    <path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 .001 4.001A2 2 0 0 0 17 18zM6.2 6l1.45 7.72A3 3 0 0 0 10.6 16h6.26a3 3 0 0 0 2.95-2.42l1-5.08A1 1 0 0 0 20.83 7H7.12L6.8 5.4A2 2 0 0 0 4.86 4H3v2h1.86l1.34 6.67"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="m-0 fw-bold">Compras</p>
                                <p class="m-0 text-muted">Evolución de costos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="ua-card-tile" data-url="@Url.Action("Inventario", "Reportes")" data-title="Inventario">
                        <div class="d-flex align-items-center">
                            <div class="ua-tile-icon ua-tile-navy">
                                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                    <path d="M3 7h18v2H3zM3 11h18v2H3zM3 15h18v2H3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="m-0 fw-bold">Inventario</p>
                                <p class="m-0 text-muted">Stock y rotación</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="ua-card-tile" data-url="@Url.Action("Pedidos", "Reportes")" data-title="Pedidos">
                        <div class="d-flex align-items-center">
                            <div class="ua-tile-icon ua-tile-lime">
                                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                    <path d="M21 7H7V3h14v4zM7 21h14v-8H7v8zM3 5h2v14H3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="m-0 fw-bold">Pedidos</p>
                                <p class="m-0 text-muted">Estados y cumplimiento</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="ua-card-tile" data-url="@Url.Action("Usuarios", "Reportes")" data-title="Usuarios">
                        <div class="d-flex align-items-center">
                            <div class="ua-tile-icon ua-tile-mag2">
                                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                    <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 4v2h16v-2c0-1.83-3.67-4-8-4z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="m-0 fw-bold">Usuarios</p>
                                <p class="m-0 text-muted">Roles y actividad</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="ua-card-tile" data-url="@Url.Action("Empleados", "Reportes")" data-title="Empleados">
                        <div class="d-flex align-items-center">
                            <div class="ua-tile-icon ua-tile-gold">
                                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                    <path d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm8 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zM8 13c-2.33 0-7 1.17-7 3.5V19h7v-2.5c0-1.01.45-1.95 1.21-2.68C8.83 13.26 8.43 13 8 13z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="m-0 fw-bold">Empleados</p>
                                <p class="m-0 text-muted">Áreas y puestos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="ua-card-tile" data-url="@Url.Action("Clientes", "Reportes")" data-title="Clientes">
                        <div class="d-flex align-items-center">
                            <div class="ua-tile-icon ua-tile-navy">
                                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                    <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 4v2h16v-2c0-1.83-3.67-4-8-4z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="m-0 fw-bold">Clientes</p>
                                <p class="m-0 text-muted">Segmentación y top</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Panel (derecha) -->
        <div class="col-lg-7">
            <div id="reportContainer" class="mb-4">
                <div class="ua-panel-header">
                    <h5 id="reportTitle" class="ua-panel-title">Selecciona un reporte</h5>
                    <div class="d-flex gap-2">
                        <!-- Botón LIMPIAR -->
                        <button type="button" class="btn btn-sm btn-cancel" id="btnClear">Limpiar</button>
                        <!-- Botón RECARGAR -->
                        <button type="button" class="btn btn-sm btn-cargar" id="btnReload" disabled>Recargar</button>
                        <!-- Botón MAXIMIZAR (modal) -->
                        <button type="button" class="btn btn-sm btn-enviado" id="btnMaximize" disabled>
                            Maximizar
                        </button>
                    </div>
                </div>
                <div class="ua-panel-body" id="reportBody">
                    <div class="text-muted">Haz clic en una tarjeta para cargar los gráficos aquí.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================= Modal Reutilizable ========================= -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:3px solid #EEE;">
                <h5 class="modal-title fw-bold" id="reportModalTitle">Reporte</h5>

                <!--Botón Exportar PDF -->
                <div class="d-flex align-items-center gap-2">
                    <a id="btnExportPdf" class="btn btn-sm btn-enviado" target="_blank" rel="noopener">
                        Exportar PDF
                    </a>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
            </div>
            <div class="modal-body" id="reportModalBody">
                <div class="ua-loader"><div class="ua-spinner"></div><div>Cargando…</div></div>
            </div>
        </div>
    </div>
</div>


<script>
    /* ================================================================
       Carga dinámica de parciales + Maximizar en modal
       - Guardamos lastUrl/lastTitle para Recargar y Maximizar
       - Maximizar vuelve a cargar el partial dentro del modal
       ================================================================ */
    const $body = document.getElementById('reportBody');
    const $title = document.getElementById('reportTitle');
    const $btnReload = document.getElementById('btnReload');
    const $btnClear = document.getElementById('btnClear');
    const $btnMax = document.getElementById('btnMaximize');
    const $btnExportPdf = document.getElementById('btnExportPdf');

    let lastUrl = null, lastTitle = null;

        // Obtiene el nombre de módulo a partir del endpoint actual
    function getModuloFromUrl(url){
      if(!url) return null;
      if(url.includes('/Usuarios'))  return 'Usuarios';
      if(url.includes('/Empleados')) return 'Empleados';
      if(url.includes('/Clientes'))  return 'Clientes';
      if(url.includes('/Ventas'))    return 'Ventas';   // ← Cuando implementes PDFs de estos, ya estará listo
      if(url.includes('/Compras'))   return 'Compras';
      if(url.includes('/Inventario'))return 'Inventario';
      if(url.includes('/Pedidos'))   return 'Pedidos';
      return null;
    }

    // Maximizar: abre modal y carga mismo parcial
    $btnMax.addEventListener('click', ()=>{
      if(!lastUrl) return;
      openModalWithPartial(lastUrl, lastTitle || 'Reporte');
    });

    // Dentro de openModalWithPartial, al final de la carga del HTML, setea el link del PDF:
    async function openModalWithPartial(url, title){
      const modalEl = document.getElementById('reportModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      document.getElementById('reportModalTitle').textContent = title;
      document.getElementById('reportModalBody').innerHTML = `
          <div class="ua-loader"><div class="ua-spinner"></div><div>Cargando ${title}…</div></div>`;
      modal.show();

      try{
        const res = await fetch(url,{credentials:'same-origin'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const html = await res.text();
        const body = document.getElementById('reportModalBody');
        body.innerHTML = html;
        reexecuteScripts(body);

        // 🔗 Armar URL del PDF para el módulo actual y setear en el botón
        const modulo = getModuloFromUrl(url);
        const exportBase = '@Url.Action("Export", "Reportes")';
        const pdfUrl = exportBase + '?modulo=' + encodeURIComponent(modulo || 'Usuarios');
        $btnExportPdf.setAttribute('href', pdfUrl);

      }catch(err){
        console.error(err);
        document.getElementById('reportModalBody').innerHTML =
          `<div class="alert alert-danger">No se pudo cargar <b>${title}</b>.<br><small>${err.message}</small></div>`;
        $btnExportPdf.removeAttribute('href'); // desactiva PDF si falló
      }
    }

    // Click en tarjetas del mosaico
    document.querySelectorAll('.ua-card-tile').forEach(tile=>{
      tile.addEventListener('click', ()=>{
        const url = tile.getAttribute('data-url');
        const title = tile.getAttribute('data-title') || 'Reporte';
        loadPartial(url, title);
      });
    });

    // Limpiar panel
    $btnClear.addEventListener('click', ()=>{
      $title.textContent = 'Selecciona un reporte';
      $body.innerHTML = '<div class="text-muted">Haz clic en una tarjeta para cargar los gráficos aquí.</div>';
      $btnReload.disabled = true;
      $btnMax.disabled = true;
      lastUrl = null; lastTitle = null;
    });

    // Recargar panel
    $btnReload.addEventListener('click', ()=>{
      if(lastUrl){ loadPartial(lastUrl, lastTitle); }
    });

    // ✅ Maximizar: abre modal y carga el MISMO endpoint
    $btnMax.addEventListener('click', ()=>{
      if(!lastUrl) return;
      openModalWithPartial(lastUrl, lastTitle || 'Reporte');
    });

    // Función principal para cargar el partial en el panel derecho
    async function loadPartial(url, title){
      lastUrl = url; lastTitle = title;
      $title.textContent = title;
      $btnReload.disabled = false;
      $btnMax.disabled = false;

      $body.innerHTML = `<div class="ua-loader"><div class="ua-spinner"></div><div>Cargando ${title}…</div></div>`;

      try{
        const res = await fetch(url,{credentials:'same-origin'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const html = await res.text();
        $body.innerHTML = html;
        reexecuteScripts($body); // asegura gráficos si el navegador no ejecuta scripts inyectados
      }catch(err){
        console.error(err);
        $body.innerHTML = `<div class="alert alert-danger">Error cargando <b>${title}</b>.<br><small>${err.message}</small></div>`;
      }
    }

    // Carga el partial dentro del modal XL
    async function openModalWithPartial(url, title){
      // Mostrar modal
      const modalEl = document.getElementById('reportModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      document.getElementById('reportModalTitle').textContent = title;
      document.getElementById('reportModalBody').innerHTML = `
          <div class="ua-loader"><div class="ua-spinner"></div><div>Cargando ${title}…</div></div>`;

      modal.show();

      try{
        const res = await fetch(url,{credentials:'same-origin'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const html = await res.text();
        const body = document.getElementById('reportModalBody');
        body.innerHTML = html;
        reexecuteScripts(body); // Chart.js dentro del modal
      }catch(err){
        console.error(err);
        document.getElementById('reportModalBody').innerHTML =
          `<div class="alert alert-danger">No se pudo cargar <b>${title}</b>.<br><small>${err.message}</small></div>`;
      }
    }

    // Re-ejecuta scripts de un fragmento HTML insertado
    function reexecuteScripts(root){
      const scripts = root.querySelectorAll('script');
      scripts.forEach(old=>{
        const s = document.createElement('script');
        [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
        s.text = old.text || '';
        old.replaceWith(s);
      });
    }
</script>
