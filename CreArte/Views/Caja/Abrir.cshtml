@model CreArte.ModelsPartial.CajaAperturaVM
@{
    ViewData["Title"] = "Abrir Caja";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-3">
    <!-- Toolbar superior -->
    <div class="ua-toolbar">
        <h2 class="m-0">Abrir sesión de caja</h2>
        <!-- Buscador vacío (no aplica en esta pantalla) -->
        <div></div>
    </div>

    <div class="ua-card">
        <!-- Form principal -->
        <form asp-action="Abrir" method="post" id="frmAbrir" autocomplete="off">
            @Html.AntiForgeryToken()

            <!-- Usuario: usamos el actual y lo enviamos oculto -->
            <input asp-for="UsuarioId" type="hidden" value="@(User.Identity?.Name)" />
            <div class="mb-2">
                <label class="form-label"><strong>Usuario:</strong></label>
                <div class="form-control" style="background:#f8f9fa" readonly>@(User.Identity?.Name ?? "usuario")</div>
            </div>

            <!-- Monto inicial -->
            <div class="mb-2">
                <label asp-for="MontoInicial" class="form-label"><strong>Monto inicial (Q):*</strong></label>

                @if (Model.BloquearMonto)
                {
                    <!-- Readonly cuando hay sesión previa cerrada -->
                    <input asp-for="MontoInicial"
                           type="number" step="0.01" min="0"
                           class="form-control" readonly />
                }
                else
                {
                    <!-- Editable en la primera sesión -->
                    <input asp-for="MontoInicial"
                           type="number" step="0.01" min="0"
                           class="form-control" required />
                }

                <small class="text-muted d-block mt-1">
                    @Model.InfoAnterior
                </small>

                <span asp-validation-for="MontoInicial" class="text-danger"></span>
            </div>

            <!-- Observaciones -->
            <div class="mb-3">
                <label asp-for="Observaciones" class="form-label"><strong>Observaciones:</strong></label>
                <textarea asp-for="Observaciones" class="form-control" maxlength="200" placeholder="Opcional"></textarea>
            </div>

            <!-- Acciones -->
            <div class="ua-actions">
                <a class="btn-cancel" href="@Url.Action("Index", "Caja")">
                    <i class="bi bi-x-circle"></i> <span>Cancelar</span>
                </a>
                <button id="btnAbrir" type="submit" class="btn-save">
                    <i class="bi bi-unlock-fill"></i> <span>Abrir caja</span>
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Evita wheel/teclas si readonly
        (function(){
          const input = document.querySelector('[name="MontoInicial"]');
          const readonly = input.hasAttribute('readonly');
          if (readonly) {
            input.addEventListener('keydown', e => e.preventDefault());
            input.addEventListener('wheel',  e => e.preventDefault(), {passive:false});
          }
        })();
                (function () {
          const form    = document.getElementById('frmAbrir');
          const btn     = document.getElementById('btnAbrir');
          const usuario = document.getElementById('UsuarioId') || document.querySelector('[name="UsuarioId"]');
          const monto   = document.getElementById('MontoInicial') || document.querySelector('[name="MontoInicial"]');

          function evalReady() {
            const okUser  = !!(usuario && (usuario.value || '').trim().length > 0);

            let okMonto = false;
            if (monto) {
              const raw = ((monto.value ?? '') + '').replace(',', '.');
              const num = Number(raw);
              okMonto = raw.length > 0 && !Number.isNaN(num) && num >= 0;
            }

            const ready = okUser && okMonto;

            if (btn) {
              btn.disabled = !ready;
              btn.classList.toggle('enabled', ready);
              btn.setAttribute('aria-disabled', String(!ready));
              btn.title = ready ? 'Abrir caja' : 'Complete los campos obligatorios';
            }
          }

          // Eventos
          if (monto)   monto.addEventListener('input',  evalReady);
          if (usuario) usuario.addEventListener('input', evalReady);

          // Primera evaluación al cargar
          evalReady();

          // Reforzar en el submit (no enviar si no está listo)
          if (form) {
            form.addEventListener('submit', function (e) {
              // Si el botón está deshabilitado, no enviamos
              if (btn && btn.disabled) {
                e.preventDefault();
                Swal.fire({
                  icon: 'warning',
                  title: 'Campos incompletos',
                  text: 'Verifica el usuario y el monto inicial (debe ser un número mayor o igual a 0).'
                });
                return;
              }

              // Tu confirmación existente
              e.preventDefault();
              const val = ((monto?.value ?? '0') + '').replace(',', '.');
              const num = Number(val);
              Swal.fire({
                icon: 'question',
                title: '¿Abrir caja?',
                html: `Monto inicial: <b>Q ${Number.isFinite(num) ? num.toFixed(2) : '0.00'}</b>`,
                showCancelButton: true,
                confirmButtonText: 'Abrir',
                cancelButtonText: 'Cancelar'
              }).then(r => {
                if (r.isConfirmed) form.submit();
              });
            });
          }
        })();
        // Confirmación
        document.getElementById('frmAbrir').addEventListener('submit', function(e){
          e.preventDefault();
          const monto = Number(document.querySelector('[name="MontoInicial"]').value || 0);
          if (!document.querySelector('[name="MontoInicial"]').hasAttribute('readonly') && monto < 0) {
            Swal.fire({icon:'warning', title:'Monto inválido', text:'El monto inicial no puede ser negativo.'});
            return;
          }
          Swal.fire({
            icon:'question',
            title:'¿Abrir caja?',
            html:`Monto inicial: <b>Q ${monto.toFixed(2)}</b>`,
            showCancelButton:true, confirmButtonText:'Abrir', cancelButtonText:'Cancelar'
          }).then(r => { if (r.isConfirmed) e.target.submit(); });
        });

        // TempData
        (function(){
          const ok  = '@(TempData["ok"] ?? "")';
          const err = '@(TempData["error"] ?? "")';
          if (ok)  Swal.fire({icon:'success',title:ok,timer:2600,showConfirmButton:false});
          if (err) Swal.fire({icon:'error',title:err,timer:2800,showConfirmButton:false});
        })();
    </script>
}

