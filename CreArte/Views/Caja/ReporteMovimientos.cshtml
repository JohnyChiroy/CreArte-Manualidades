@model CreArte.ModelsPartial.ReporteViewModel<CreArte.ModelsPartial.CajaDetalleMovimientoVM>
@{
    Layout = null;

    var titulo = string.IsNullOrWhiteSpace(Model.ReportTitle)
        ? "Movimientos de Caja"
        : Model.ReportTitle;

    var logoUrl = string.IsNullOrWhiteSpace(Model.LogoUrl)
        ? Url.Content("~/Imagenes/logoCreArte.png")
        : Model.LogoUrl;

    var empresaInfo = string.IsNullOrWhiteSpace(Model.CompanyInfo)
        ? "CreArte Manualidades"
        : Model.CompanyInfo;

    var generadoPor = string.IsNullOrWhiteSpace(Model.GeneratedBy)
        ? ""
        : Model.GeneratedBy;

    // Header de sesión
    var h = ViewBag.Header;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@titulo</title>
    <style>
        /* Reset seguro PDF */
        * {
            box-sizing: border-box
        }

        html, body {
            margin: 0;
            padding: 0;
            background: #fff;
        }

        body {
            font-family: Arial,Helvetica,sans-serif;
            font-size: 12px;
            color: black;
            line-height: 1.35
        }

        /* ===== Header minimal ===== */
        .header {
            padding: 10px 10px;
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
        }

            .header-table td {
                border: 0;
                vertical-align: middle;
                background: transparent !important;
            }

        .h-left {
            font-size: 26px;
            font-weight: bold;
            letter-spacing: .3px;
        }

        .h-sub {
            font-size: 11px;
            margin-top: 3px;
        }

        .h-right {
            width: 80px;
            text-align: right;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Ajustes específicos de la imagen */
        .logo {
            width: 110px;
            height: 60px;
            object-fit: cover;
            object-position: center;
            display: inline-block; /* o block, pero inline-block se ajusta mejor aquí */
            border-radius: 8px;
            /* border: 1px solid #eee; */
            /* background: #fafafa; */
        }

        /* ===== Contenedor ===== */
        .container {
            padding: 8px 18px 14px 18px;
        }

        /* ===== Tarjeta de sesión ===== */
        .session-card {
            border: 1px solid #E6E6E6;
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .session-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .session-grid {
            display: table;
            width: 100%;
            font-size: 11px;
        }

        .session-row {
            display: table-row;
        }

        .session-cell {
            display: table-cell;
            padding: 2px 8px 2px 0;
        }

        .badge-estado {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: bold;
        }

        .badge-estado--abierta {
            background: #C5D930;
            color: #101400;
        }

        .badge-estado--cerrada {
            background: #FF007D;
            color: #fff;
        }

        /* ===== Tabla de movimientos ===== */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 8px;
        }

        th, td {
            padding: 7px 8px;
            vertical-align: middle;
            text-align: center;
            border-bottom: 1px solid #C5D930;
        }

        thead th {
            background: #C5D930;
            color: black;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .4px;
        }

            thead th:first-child {
                border-top-left-radius: 7px;
            }

            thead th:last-child {
                border-top-right-radius: 7px;
            }

        .nowrap {
            white-space: nowrap;
        }

        .badge-tipo {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: bold;
        }

        .badge-tipo--ingreso {
            background: #03C1FF;
            color: #fff;
        }

        .badge-tipo--egreso {
            background: #FF007D;
            color: #fff;
        }

        .monto {
            text-align: right;
            font-family: Arial,Helvetica,sans-serif;
            font-size: 12px;
            color: black;
            line-height: 1.35
        }

        /* Totales simples (conteos) */
        .totals {
            margin-top: 10px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid #DDEB8B;
            color: #242259;
            font-weight: bold;
            font-size: 11px;
        }

            .totals .ok {
                color: #03C1FF
            }

            .totals .no {
                color: #FF007D
            }

        .note {
            margin-top: 6px;
            font-size: 10px;
            color: #444;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <table class="header-table">
            <tr>
                <td>
                    <div class="h-left">@titulo</div>
                    <div class="h-sub">
                        @empresaInfo
                        @if (!string.IsNullOrWhiteSpace(generadoPor))
                        {
                            <text> | Generado por: @generadoPor</text>
                        }
                        | @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")
                    </div>
                </td>
                <td class="h-right">
                    <span class="logo"><img src="@logoUrl" alt="Logo" /></span>
                </td>
            </tr>
        </table>
    </header>

    <main class="container">
        <!-- Card de la sesión -->
        @if (h != null)
        {
            bool abierta = false;
            try { abierta = (bool)h.Estado; } catch { }

            <div class="session-card">
                <div class="session-title">
                    Sesión: @h.SesionId
                    @if (abierta)
                    {
                        <span class="badge-estado badge-estado--abierta">ABIERTA</span>
                    }
                    else
                    {
                        <span class="badge-estado badge-estado--cerrada">CERRADA</span>
                    }
                </div>
                <div class="session-grid">
                    <div class="session-row">
                        <div class="session-cell"><strong>Fecha apertura:</strong> @(((DateTime?)h.FechaAper)?.ToString("dd/MM/yyyy HH:mm:ss") ?? "—")</div>
                        <div class="session-cell"><strong>Fecha cierre:</strong> @(((DateTime?)h.FechaCierre)?.ToString("dd/MM/yyyy HH:mm:ss") ?? "—")</div>
                    </div>
                    <div class="session-row">
                        <div class="session-cell"><strong>Monto inicial:</strong> @((decimal)h.MontoInicial).ToString("Q0.00")</div>
                        <div class="session-cell"><strong>Ingresos:</strong> @((decimal)h.Ingresos).ToString("Q0.00")</div>
                        <div class="session-cell"><strong>Egresos:</strong> @((decimal)h.Egresos).ToString("Q0.00")</div>
                        <div class="session-cell"><strong>Saldo final:</strong> @((decimal)h.Saldo).ToString("Q0.00")</div>
                    </div>
                </div>
            </div>
        }

        <!-- Tabla de movimientos -->
        <table>
            <thead>
                <tr>
                    <th class="nowrap" style="width:12%;">ID</th>
                    <th class="nowrap" style="width:18%;">Fecha</th>
                    <th style="width:15%;">Tipo</th>
                    <th>Referencia</th>
                    <th style="width:20%;">Usuario</th>
                    <th class="nowrap" style="width:12%;">Monto</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items != null && Model.Items.Any())
                {
                    foreach (var m in Model.Items)
                    {
                        <tr>
                            <td class="nowrap">@m.MovimientoId</td>
                            <td class="nowrap">@m.Fecha.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            <td>
                                @if (string.Equals(m.TipoMovimiento, "INGRESO", StringComparison.OrdinalIgnoreCase))
                                {
                                    <span class="badge-tipo badge-tipo--ingreso">INGRESO</span>
                                }
                                else if (string.Equals(m.TipoMovimiento, "EGRESO", StringComparison.OrdinalIgnoreCase))
                                {
                                    <span class="badge-tipo badge-tipo--egreso">EGRESO</span>
                                }
                                else
                                {
                                    <span class="badge-tipo">@m.TipoMovimiento</span>
                                }
                            </td>
                            <td style="text-align:center;">@m.Referencia</td>
                            <td>@m.UsuarioNombre</td>
                            <td class="monto">@m.Monto.ToString("Q0.00")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="6" style="text-align:center;padding:14px;">No hay movimientos para esta sesión.</td></tr>
                }
            </tbody>
        </table>

        <!-- Totales (conteos) -->
        <div class="totals">
            Total de movimientos: @Model.GetTotal("Movimientos")
            ·<span class="ok">Ingresos: @Model.GetTotal("Ingresos")</span>
            · <span class="no">Egresos: @Model.GetTotal("Egresos")</span>
        </div>

        <div class="note">
            CreArte Manualidades | Reporte de movimientos de caja generado automáticamente.
        </div>
    </main>
</body>
</html>
