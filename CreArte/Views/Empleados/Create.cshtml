@* ===============================================
   RUTA: Views/Empleados/Create.cshtml
   DESCRIPCIÓN: Formulario de creación de EMPLEADO.
   - Captura integrada de PERSONA + EMPLEADO (IDs sincronizados)
   - 10 campos obligatorios (HTML + DataAnnotations)
   - ESTADO con "pill", guard para habilitar botón
   - PRG con SweetAlert2
   =============================================== *@
@model CreArte.ModelsPartial.EmpleadoCreateVM
@{
    ViewData["Title"] = "Crear Empleado";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="ua-card">
    <h2 style="margin:0 0 12px 0;">Nuevo Empleado</h2>

    <!-- El Controller reasigna EMPLEADO_ID/PERSONA_ID en servidor -->
    <form asp-action="Create" asp-controller="Empleados" method="post" id="frmEmpleado" data-guard="true" autocomplete="off">
        @Html.AntiForgeryToken()

        <div asp-validation-summary="ModelOnly" class="text-danger validation-summary-errors"></div>

        <!-- Fila superior: Código + Estado -->
        <div class="ua-row">
            <div class="ua-field">
                <div class="ua-kv">
                    <label asp-for="EMPLEADO_ID"><strong>Código Empleado:</strong></label>
                    <input asp-for="EMPLEADO_ID" class="form-control" readonly />
                    <input type="hidden" asp-for="PERSONA_ID" />
                </div>
                <span asp-validation-for="EMPLEADO_ID" class="text-danger"></span>
            </div>

            <div class="ua-field">
                <div class="ua-kv">
                    <label><strong>Estado:</strong></label>
                    <span id="pillEstado" class="ua-pill@(Model?.ESTADO == true ? " active" : "")">
                        @(Model?.ESTADO == true ? "Activo" : "Inactivo")
                    </span>
                </div>
                <div class="ua-switch" style="margin-top:2px;">
                    <input asp-for="ESTADO" type="checkbox" id="chkEstado" />
                    <span>Activo</span>
                </div>
                <span asp-validation-for="ESTADO" class="text-danger"></span>
            </div>
        </div>

        @* ==============================
           PERSONA: Nombres
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label asp-for="PERSONA_PRIMERNOMBRE"><strong>Primer Nombre:*</strong></label>
                <input asp-for="PERSONA_PRIMERNOMBRE" class="form-control" maxlength="50" required />
                <span asp-validation-for="PERSONA_PRIMERNOMBRE" class="text-danger"></span>
                @* <div class="ua-help"><span id="cntNom1">0</span></div> *@
            </div>
            <div class="ua-field">
                <label asp-for="PERSONA_SEGUNDONOMBRE"><strong>Segundo Nombre:</strong></label>
                <input asp-for="PERSONA_SEGUNDONOMBRE" class="form-control" maxlength="50" />
                <span asp-validation-for="PERSONA_SEGUNDONOMBRE" class="text-danger"></span>
                @* <div class="ua-help"><span id="cntNom2">0</span></div> *@
            </div>
            <div class="ua-field">
                <label asp-for="PERSONA_TERCERNOMBRE"><strong>Tercer Nombre:</strong></label>
                <input asp-for="PERSONA_TERCERNOMBRE" class="form-control" maxlength="50" />
                <span asp-validation-for="PERSONA_TERCERNOMBRE" class="text-danger"></span>
                @* <div class="ua-help"><span id="cntNom3">0</span></div> *@
            </div>
        </div>

        @* ==============================
           PERSONA: Apellidos
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label asp-for="PERSONA_PRIMERAPELLIDO"><strong>Primer Apellido:*</strong></label>
                <input asp-for="PERSONA_PRIMERAPELLIDO" class="form-control" maxlength="50" required />
                <span asp-validation-for="PERSONA_PRIMERAPELLIDO" class="text-danger"></span>
                @* <div class="ua-help"><span id="cntApe1">0</span></div> *@
            </div>
            <div class="ua-field">
                <label asp-for="PERSONA_SEGUNDOAPELLIDO"><strong>Segundo Apellido:</strong></label>
                <input asp-for="PERSONA_SEGUNDOAPELLIDO" class="form-control" maxlength="50" />
                <span asp-validation-for="PERSONA_SEGUNDOAPELLIDO" class="text-danger"></span>
                @* <div class="ua-help"><span id="cntApe2">0</span></div> *@
            </div>
            <div class="ua-field">
                <label asp-for="PERSONA_APELLIDOCASADA"><strong>Apellido de Casada:</strong></label>
                <input asp-for="PERSONA_APELLIDOCASADA" class="form-control" maxlength="50" />
                <span asp-validation-for="PERSONA_APELLIDOCASADA" class="text-danger"></span>
                @* <div class="ua-help"><span id="cntApeC">0</span></div> *@
            </div>
        </div>

        @* ==============================
           PERSONA: NIT / CUI (DPI)
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label asp-for="PERSONA_NIT"><strong>NIT:*</strong></label>
                <input asp-for="PERSONA_NIT"
                       class="form-control"
                       maxlength="15"
                       pattern="^[0-9-]{6,15}$"
                       inputmode="numeric"
                       title="Ingrese entre 6 y 15 caracteres (números y guiones). Ej.: 1234567-8" />
                <span asp-validation-for="PERSONA_NIT" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="PERSONA_CUI"><strong>CUI / DPI:*</strong></label>
                <input asp-for="PERSONA_CUI"
                       class="form-control"
                       maxlength="13"
                       required
                       pattern="^\d{13}$"
                       inputmode="numeric"
                       title="El CUI/DPI debe tener exactamente 13 dígitos numéricos." />
                <span asp-validation-for="PERSONA_CUI" class="text-danger"></span>
            </div>
        </div>

        @* ==============================
           PERSONA: Contacto (Casa/Móvil/Correo)
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label asp-for="PERSONA_TELEFONOCASA"><strong>Teléfono (Casa):</strong></label>
                <input asp-for="PERSONA_TELEFONOCASA" class="form-control" maxlength="15" />
                @* OPCIONAL: no required *@
                <span asp-validation-for="PERSONA_TELEFONOCASA" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="PERSONA_TELEFONOMOVIL"><strong>Teléfono (Celular)*:</strong></label>
                <input asp-for="PERSONA_TELEFONOMOVIL" class="form-control" maxlength="15" required />
                @* OBLIGATORIO *@
                <span asp-validation-for="PERSONA_TELEFONOMOVIL" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="PERSONA_CORREO"><strong>Correo:*</strong></label>
                <input asp-for="PERSONA_CORREO" type="email" class="form-control" maxlength="150" required />
                @* OBLIGATORIO *@
                <span asp-validation-for="PERSONA_CORREO" class="text-danger"></span>
            </div>
        </div>

        @* ==============================
           PERSONA: Dirección
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field" style="flex:1 1 100%;">
                <label asp-for="PERSONA_DIRECCION"><strong>Dirección:*</strong></label>
                <input asp-for="PERSONA_DIRECCION" class="form-control" maxlength="255" required />
                <span asp-validation-for="PERSONA_DIRECCION" class="text-danger"></span>
            </div>
        </div>

        @* ==============================
           EMPLEADO: Puesto / Género
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label asp-for="PUESTO_ID"><strong>Puesto:*</strong></label>
                <select asp-for="PUESTO_ID" class="form-control" asp-items="Model.Puestos" required>
                    <option value="">Seleccione un puesto ↓</option>
                </select>
                <span asp-validation-for="PUESTO_ID" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="EMPLEADO_GENERO"><strong>Género:*</strong></label>
                <select asp-for="EMPLEADO_GENERO" class="form-control" asp-items="Model.Generos" required></select>
                <span asp-validation-for="EMPLEADO_GENERO" class="text-danger"></span>
            </div>
        </div>

        @* ==============================
           EMPLEADO: Fechas
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label asp-for="EMPLEADO_FECHANACIMIENTO"><strong>Fecha de Nacimiento:*</strong></label>
                <input asp-for="EMPLEADO_FECHANACIMIENTO" type="date" class="form-control" required />
                <span asp-validation-for="EMPLEADO_FECHANACIMIENTO" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="EMPLEADO_FECHAINGRESO"><strong>Fecha de Ingreso:*</strong></label>
                <input asp-for="EMPLEADO_FECHAINGRESO" type="date" class="form-control" required />
                <span asp-validation-for="EMPLEADO_FECHAINGRESO" class="text-danger"></span>
            </div>
        </div>

        <!-- Acciones -->
        <div class="ua-actions">
            <a class="btn-cancel js-leave" asp-action="Index" asp-controller="Empleados">
                <i class="bi bi-x-circle"></i> <span>Cancelar</span>
            </a>
            <button id="btnGuardar" type="submit" class="btn-save" disabled>
                <i class="bi bi-save"></i> <span>Guardar</span>
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Contadores (opcional)
        (function () {
            const bindCount = (inputId, labelId, max) => {
                const i = document.getElementById(inputId), l = document.getElementById(labelId);
                if (!i || !l) return; const upd = () => l.textContent = (i.value || '').length + '/' + max;
                upd(); i.addEventListener('input', upd);
            };
            bindCount('PERSONA_PRIMERNOMBRE','cntNom1',50);
            bindCount('PERSONA_SEGUNDONOMBRE','cntNom2',50);
            bindCount('PERSONA_TERCERNOMBRE','cntNom3',50);
            bindCount('PERSONA_PRIMERAPELLIDO','cntApe1',50);
            bindCount('PERSONA_SEGUNDOAPELLIDO','cntApe2',50);
            bindCount('PERSONA_APELLIDOCASADA','cntApeC',50);
        })();

        // Pill Estado
        (function () {
            const chk = document.getElementById('chkEstado');
            const pill = document.getElementById('pillEstado');
            if (!chk || !pill) return;
            const syncPill = () => chk.checked ? (pill.classList.add('active'), pill.textContent = 'Activo')
                                               : (pill.classList.remove('active'), pill.textContent = 'Inactivo');
            chk.addEventListener('change', syncPill); syncPill();
        })();

        // Helper edad a la fecha de ingreso
        function calcAgeOn(isoBirth, isoOn) {
            if (!isoBirth || !isoOn) return null;
            const fn = new Date(isoBirth + 'T00:00:00');
            const fi = new Date(isoOn   + 'T00:00:00');
            let age = fi.getFullYear() - fn.getFullYear();
            const anniv = new Date(fi.getFullYear(), fn.getMonth(), fn.getDate());
            if (fi < anniv) age--;
            return age;
        }

        // Habilitar botón Guardar (10 obligatorios + EDAD ≥ 13 + checkValidity)
        (function () {
            const btn = document.getElementById('btnGuardar');
            const form = document.getElementById('frmEmpleado');
            const reqIds = [
                'PERSONA_PRIMERNOMBRE',
                'PERSONA_PRIMERAPELLIDO',
                'PERSONA_CUI',
                'PERSONA_TELEFONOMOVIL',
                'PERSONA_CORREO',
                'PERSONA_DIRECCION',
                'PUESTO_ID',
                'EMPLEADO_GENERO',
                'EMPLEADO_FECHANACIMIENTO',
                'EMPLEADO_FECHAINGRESO'
            ];
            const els = reqIds.map(id => document.getElementById(id));
            const elFn = document.getElementById('EMPLEADO_FECHANACIMIENTO');
            const elFi = document.getElementById('EMPLEADO_FECHAINGRESO');

            function ready() {
                const baseOk = els.every(el => el && (el.value || '').trim().length > 0);

                // Edad ≥ 13 a la fecha de ingreso
                let ageOk = true;
                if (elFn && elFi && elFn.value && elFi.value) {
                    const edad = calcAgeOn(elFn.value, elFi.value);
                    ageOk = (edad !== null && edad >= 13);
                    if (!ageOk) elFn.setCustomValidity('El empleado debe tener más de 12 años (≥ 13) a la fecha de ingreso.');
                    else elFn.setCustomValidity('');
                } else {
                    if (elFn) elFn.setCustomValidity('');
                }

                const ok = baseOk && ageOk && (form ? form.checkValidity() : true);
                if (!btn) return;
                btn.disabled = !ok;
                btn.classList.toggle('enabled', ok);
            }

            els.forEach(el => el && el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', ready));
            if (elFn) elFn.addEventListener('change', ready);
            if (elFi) elFi.addEventListener('change', ready);
            ready();
        })();

        // Prevenir doble submit
        (function () {
            const frm = document.getElementById('frmEmpleado');
            const btn = document.getElementById('btnGuardar');
            if (!frm || !btn) return;
            frm.addEventListener('submit', function () {
                btn.disabled = true; btn.classList.remove('enabled');
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
            });
        })();

        // PRG (SweetAlert2) con TempData
        (function () {
            if (!window.Swal) return;
            const title='@(TempData["SwalTitle"] ?? "")', text='@(TempData["SwalText"] ?? "")';
            const urlIndex='@(TempData["SwalIndexUrl"] ?? "")', urlCreate='@(TempData["SwalCreateUrl"] ?? "")';
            if (!title && !text) return;
            Swal.fire({ icon:'success', title:title||'Guardado', text:text||'El registro se creó correctamente.',
                showDenyButton:true, confirmButtonText:'Volver al listado', denyButtonText:'Crear otro',
                allowOutsideClick:false, allowEscapeKey:false
            }).then(r=>{ if (r.isConfirmed && urlIndex) location.href=urlIndex; else if (r.isDenied && urlCreate) location.href=urlCreate; });
        })();
    </script>
}
