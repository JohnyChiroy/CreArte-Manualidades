@* Views/Shared/_Sidebar.cshtml *@
@using CreArte.Services.Security
@inject ICreArtePermissionService Perms

@{
    Layout = null;

    // Contexto para .is-active
    var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "").ToLowerInvariant();
    var act  = (ViewContext.RouteData.Values["action"]?.ToString() ?? "").ToLowerInvariant();

    Func<string, bool> isCtrl = c => ctrl == (c ?? "").ToLowerInvariant();
    Func<string, string, string> active = (c, a) =>
        (isCtrl(c) && (string.IsNullOrEmpty(a) || act == (a ?? "").ToLowerInvariant()))
        ? "is-active" : "";

    // Helper permiso (default DENY en el servicio)
    bool Can(string moduloId) => Perms.CanView(User, moduloId);

    // Para abrir el grupo de Configuración si el usuario está en alguno de esos controladores
    var configChildren = new[] {
        "areas","puestos","niveles","roles",
        "categorias","subcategorias","unidadesmedida",
        "tiposempaque","marcas","tiposproducto","tiposcliente"
    };
    bool isConfigOpen = configChildren.Contains(ctrl);

    // ¿Hay al menos un hijo visible en el grupo Configuración?
    var cfgMods = new[] {
        "AREAS","PUESTOS","NIVELES","ROLES",
        "CATEGORIAS","SUBCATEGORIAS","UNIDADESMEDIDA",
        "TIPOSEMPAQUE","MARCAS","TIPOSPRODUCTO","TIPOSCLIENTE"
    };
    bool showConfig = cfgMods.Any(m => Can(m));
}

<aside class="app-sidebar" id="sidebar">
    <!-- Accesos rápidos arriba -->
    @if (Can("COMPRAS"))
    {
        <a asp-controller="Compras" asp-action="Index" class="nav-item @(active("compras","index"))">
            <i class="bi bi-basket"></i> <span>Compras</span>
        </a>
    }
    @if (Can("INVENTARIO"))
    {
        <a asp-controller="Inventario" asp-action="Index" class="nav-item @(active("inventario","index"))">
            <i class="bi bi-stack"></i> <span>Inventario</span>
        </a>
    }
    @if (Can("KARDEX"))
    {
        <a asp-controller="Kardex" asp-action="Index" class="nav-item @(active("kardex","index"))">
            <i class="bi bi-building-gear"></i> <span>Kardex</span>
        </a>
    }

    <nav class="sidebar-nav">
        @if (Can("CAJA"))
        {
            <a asp-controller="Caja" asp-action="Index" class="nav-item @(active("caja","index"))">
                <i class="bi bi-cash-stack"></i> <span>Caja</span>
            </a>
        }
        @if (Can("VENTAS"))
        {
            <a asp-controller="Ventas" asp-action="Index" class="nav-item @(active("ventas","index"))">
                <i class="bi bi-bag"></i> <span>Ventas</span>
            </a>
        }
        @if (Can("PEDIDOS"))
        {
            <a asp-controller="Pedidos" asp-action="Index" class="nav-item @(active("pedidos","index"))">
                <i class="bi bi-calendar2-week"></i> <span>Pedidos</span>
            </a>
        }
        @if (Can("REPORTES"))
        {
            <a asp-controller="Reportes" asp-action="Index" class="nav-item @(active("reportes","index"))">
                <i class="bi bi-clipboard2-data"></i> <span>Reportes</span>
            </a>
        }

        @* <div class="sidebar-sep"></div> *@

        @if (Can("PRODUCTOS"))
        {
            <a asp-controller="Productos" asp-action="Index" class="nav-item @(active("productos","index"))">
                <i class="bi bi-box"></i> <span>Productos</span>
            </a>
        }
        @if (Can("PROVEEDORES"))
        {
            <a asp-controller="Proveedores" asp-action="Index" class="nav-item @(active("proveedores","index"))">
                <i class="bi bi-truck"></i> <span>Proveedores</span>
            </a>
        }
        @if (Can("CLIENTES"))
        {
            <a asp-controller="Clientes" asp-action="Index" class="nav-item @(active("clientes","index"))">
                <i class="bi bi-people"></i> <span>Clientes</span>
            </a>
        }
        @if (Can("EMPLEADOS"))
        {
            <a asp-controller="Empleados" asp-action="Index" class="nav-item @(active("empleados","index"))">
                <i class="bi bi-person-badge"></i> <span>Empleados</span>
            </a>
        }
        @if (Can("USUARIOS"))
        {
            <a asp-controller="Usuarios" asp-action="Index" class="nav-item @(active("usuarios","index"))">
                <i class="bi bi-person-gear"></i> <span>Usuarios</span>
            </a>
        }
        @if (Can("PERMISOS"))
        {
            <a asp-controller="Permisos" asp-action="Index" class="nav-item @(active("permisos","index"))">
                <i class="bi bi-shield-lock"></i> <span>Permisos</span>
            </a>
        }

        @* <div class="sidebar-sep"></div> *@

        @* Grupo Configuración (solo si hay al menos un subitem visible) *@
        @if (showConfig)
        {
            <a id="cfg-toggle"
               class="nav-item nav-item-toggle no-caret @(isConfigOpen ? "is-open is-active" : "")"
               href="#cfg-sub"
               data-bs-toggle="collapse"
               aria-expanded="@(isConfigOpen.ToString().ToLower())"
               aria-controls="cfg-sub">
                <i class="bi bi-gear"></i> <span>Configuración</span>
            </a>

            <div class="collapse nav-sub @(isConfigOpen ? "show" : "")" id="cfg-sub">
                @if (Can("AREAS"))
                {
                    <a asp-controller="Areas" asp-action="Index" class="nav-item nav-item--sub @(active("areas","index"))">
                        <i class="bi bi-grid-3x3-gap"></i> <span>Áreas</span>
                    </a>
                }
                @if (Can("PUESTOS"))
                {
                    <a asp-controller="Puestos" asp-action="Index" class="nav-item nav-item--sub @(active("puestos","index"))">
                        <i class="bi bi-diagram-3"></i> <span>Puestos</span>
                    </a>
                }
                @if (Can("NIVELES"))
                {
                    <a asp-controller="Niveles" asp-action="Index" class="nav-item nav-item--sub @(active("niveles","index"))">
                        <i class="bi bi-layers"></i> <span>Niveles</span>
                    </a>
                }
                @if (Can("ROLES"))
                {
                    <a asp-controller="Roles" asp-action="Index" class="nav-item nav-item--sub @(active("roles","index"))">
                        <i class="bi bi-shield-lock"></i> <span>Roles</span>
                    </a>
                }
                @if (Can("CATEGORIAS"))
                {
                    <a asp-controller="Categorias" asp-action="Index" class="nav-item nav-item--sub @(active("categorias","index"))">
                        <i class="bi bi-tag"></i> <span>Categorías</span>
                    </a>
                }
                @if (Can("SUBCATEGORIAS"))
                {
                    <a asp-controller="SubCategorias" asp-action="Index" class="nav-item nav-item--sub @(active("subcategorias","index"))">
                        <i class="bi bi-tags"></i> <span>SubCategorías</span>
                    </a>
                }
                @if (Can("MARCAS"))
                {
                    <a asp-controller="Marcas" asp-action="Index" class="nav-item nav-item--sub @(active("marcas","index"))">
                        <i class="bi bi-receipt-cutoff"></i> <span>Marcas</span>
                    </a>
                }
                @if (Can("UNIDADESMEDIDA"))
                {
                    <a asp-controller="UnidadesMedida" asp-action="Index" class="nav-item nav-item--sub @(active("unidadesmedida","index"))">
                        <i class="bi bi-columns-gap"></i> <span>Unidad Medida</span>
                    </a>
                }
                @if (Can("TIPOSEMPAQUE"))
                {
                    <a asp-controller="TiposEmpaque" asp-action="Index" class="nav-item nav-item--sub @(active("tiposempaque","index"))">
                        <i class="bi bi-boxes"></i> <span>Tipo Empaque</span>
                    </a>
                }
                @if (Can("TIPOSPRODUCTO"))
                {
                    <a asp-controller="TiposProducto" asp-action="Index" class="nav-item nav-item--sub @(active("tiposproducto","index"))">
                        <i class="bi bi-qr-code-scan"></i> <span>Tipo Producto</span>
                    </a>
                }
                @if (Can("TIPOSCLIENTE"))
                {
                    <a asp-controller="TiposCliente" asp-action="Index" class="nav-item nav-item--sub @(active("tiposcliente","index"))">
                        <i class="bi bi-person-bounding-box"></i> <span>Tipo Cliente</span>
                    </a>
                }
            </div>
        }
    </nav>
</aside>
