@model CreArte.ModelsPartial.CompraEditVM
@{
    ViewData["Title"] = "Editar compra";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var productosJson = ViewBag.ProductosJson as string ?? "[]";
}

<div class="ua-card">
    <div class="ua-toolbar">
        <h2 class="m-0">Editar compra @Model.CompraId</h2>
        <div class="d-flex align-items-center gap-2">
            <a asp-action="Index" asp-route-id="@Model.CompraId" class="ua-btn">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" /></svg>
                Volver
            </a>
        </div>
    </div>

    <form asp-action="Edit" asp-controller="Compras" method="post" id="frmEdit" autocomplete="off">
        @Html.AntiForgeryToken()

        <!-- Cabecera -->
        <div class="ua-row mt-2">
            <div class="ua-field">
                <div class="ua-kv">
                    <label><strong>Código</strong></label>
                    <input class="form-control" value="@Model.CompraId" disabled />
                    <input type="hidden" asp-for="CompraId" />
                </div>
            </div>

            <div class="ua-field" style="flex:1">
                <label asp-for="ProveedorId"><strong>Proveedor</strong></label>
                <select asp-for="ProveedorId" asp-items="ViewBag.Proveedores" class="form-control">
                    <option value="">— Seleccione —</option>
                </select>
                <span asp-validation-for="ProveedorId" class="text-danger"></span>
            </div>

            <div class="ua-field" style="flex:1">
                <label asp-for="Observaciones"><strong>Observaciones</strong></label>
                <input asp-for="Observaciones" class="form-control" maxlength="250" />
            </div>
        </div>

        <hr class="my-3" />

        <!-- LÍNEAS: Producto, Imagen, Cantidad -->
        <div class="table-responsive">
            <table class="table table-sm align-middle" id="tblLineas">
                <thead class="table-light">
                    <tr>
                        <th style="width:42%;">Producto</th>
                        <th style="width:22%;">Imagen</th>
                        <th class="text-end" style="width:16%;">Cantidad</th>
                        <th class="text-center" style="width:12%;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbBody">
                    @for (int i = 0; i < Model.Lineas.Count; i++)
                    {
                        <tr>
                            <!-- Índice fijo para el model binder -->
                            <input type="hidden" name="Lineas.Index" value="@i" />
                            <!-- ID del detalle (si existe) -->
                            <input type="hidden" name="Lineas[@i].DetalleCompraId" value="@Model.Lineas[i].DetalleCompraId" />

                            <td>
                                <select name="Lineas[@i].ProductoId"
                                        class="form-control js-prod"
                                        data-row="@i" required
                                        asp-items="ViewBag.Productos">
                                    <option value="">— Seleccione —</option>
                                </select>
                                <div class="text-muted small mt-1 js-prod-name" data-row="@i"></div>
                            </td>

                            <td>
                                <img class="img-thumbnail js-prod-img" data-row="@i"
                                     src="" alt="Sin imagen"
                                     style="max-height:60px;max-width:120px;object-fit:contain;" />
                            </td>

                            <td class="text-end">
                                <input name="Lineas[@i].Cantidad" type="number" min="1"
                                       class="form-control text-end" value="@Model.Lineas[i].Cantidad" required />
                            </td>

                            <td class="text-center">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="rm(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <script>
                            // Seleccionar el valor actual del producto para la fila i
                            document.addEventListener('DOMContentLoaded', function () {
                                const sel = document.querySelector('select[name="Lineas[@i].ProductoId"]');
                                if (sel) { sel.value = '@Model.Lineas[i].ProductoId'; sel.dispatchEvent(new Event('change')); }
                            });
                        </script>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4">
                            <button type="button" class="ua-btn" onclick="addRow()">
                                <i class="bi bi-plus-circle"></i> Agregar producto
                            </button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="ua-actions">
            <a class="btn-cancel" asp-action="Details" asp-route-id="@Model.CompraId">
                <i class="bi bi-x-circle"></i> <span>Cancelar</span>
            </a>
            <button id="btnSave" type="submit" class="btn-save">
                <i class="bi bi-save"></i> <span>Guardar cambios</span>
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // ===== Catálogo JS (para imagen y nombre) =====
        const CAT = @Html.Raw(productosJson);
        const IDX = {}; CAT.forEach(p => IDX[p.id] = p);

        // Plantilla de opciones del select
        const optionsHtml = `
            @foreach (var pr in ViewBag.Productos as SelectList)
            {
                    @:<option value="@pr.Value">@pr.Text</option>
            }
        `;

        let nextIndex = @Model.Lineas.Count;

        function addRow(){
            const i = nextIndex++;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <input type="hidden" name="Lineas.Index" value="${i}" />
                <input type="hidden" name="Lineas[${i}].DetalleCompraId" value="" />
                <td>
                    <select name="Lineas[${i}].ProductoId" class="form-control js-prod" data-row="${i}" required>
                        <option value="">— Seleccione —</option>
                        ${optionsHtml}
                    </select>
                    <div class="text-muted small mt-1 js-prod-name" data-row="${i}"></div>
                </td>
                <td>
                    <img class="img-thumbnail js-prod-img" data-row="${i}"
                         src="" alt="Sin imagen"
                         style="max-height:60px;max-width:120px;object-fit:contain;" />
                </td>
                <td class="text-end">
                    <input name="Lineas[${i}].Cantidad" type="number" min="1" class="form-control text-end" required />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="rm(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>`;
            document.getElementById('tbBody').appendChild(tr);
            tr.querySelector('.js-prod').addEventListener('change', prodChanged);
        }

        function rm(btn){
            const tr = btn.closest('tr');
            tr && tr.remove();
        }

        function prodChanged(){
            const row = this.getAttribute('data-row');
            const info = IDX[this.value] || null;
            const img  = document.querySelector(`.js-prod-img[data-row="${row}"]`);
            const name = document.querySelector(`.js-prod-name[data-row="${row}"]`);
            if (info){ if (img) img.src = info.imagen || ''; if (name) name.textContent = info.nombre || ''; }
            else     { if (img) img.src = ''; if (name) name.textContent = ''; }
        }

        // Wire up selects ya renderizados
        document.querySelectorAll('.js-prod').forEach(s => {
            s.addEventListener('change', prodChanged);
            if (s.value) s.dispatchEvent(new Event('change'));
        });
    </script>
}
