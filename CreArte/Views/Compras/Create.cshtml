@model CreArte.ModelsPartial.CompraCreateVM

@{
    ViewData["Title"] = "Nueva Compra";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // var productosJson = (string)ViewBag.ProductosJson;
    var productosJson = ViewBag.ProductosJson as string ?? "[]";  // default seguro
}

<div class="ua-card">
    <h2 style="margin:0 0 12px 0;">Registrar Nueva Compra</h2>

    <!-- Form principal -->
    <form asp-action="Create" asp-controller="Compras" method="post" id="frmCompra" data-guard="true" autocomplete="off">
        @Html.AntiForgeryToken()

        <!-- Resumen de validación MVC -->
        <div asp-validation-summary="ModelOnly" class="text-danger validation-summary-errors"></div>

        <!-- ==============================
             Encabezado: ID (auto), Proveedor, Observaciones
             ============================== -->
        <div class="ua-row">
            <div class="ua-field">
                
                    <label><strong>Código:*</strong></label>

                    <!-- Mostramos el ID autogenerado en solo-lectura y enviamos un hidden real -->
                    <input class="form-control" value="@Model.CompraId" disabled />
                    <input type="hidden" asp-for="CompraId" />
               
                <span asp-validation-for="CompraId" class="text-danger"></span>

                <label asp-for="ProveedorId"><strong>Proveedor:*</strong></label>
                <select asp-for="ProveedorId" class="form-control" required>
                    <option value="">Seleccione ↓</option>
                    @foreach (var p in ViewBag.Proveedores as SelectList)
                    {
                        <option value="@p.Value">@p.Text</option>
                    }
                </select>
                <span asp-validation-for="ProveedorId" class="text-danger"></span>
            </div>

            <div class="ua-field" style="flex:1">
                <label asp-for="Observaciones"><strong>Observaciones:</strong></label>
                <input asp-for="Observaciones" class="form-control" maxlength="250" />
            </div>
        </div>

        <!-- ==============================================
             LÍNEAS DE PRODUCTOS: SOLO Producto, Imagen, Cantidad
             ============================================== -->
        <div style="margin-top:12px;">
            <div class="ua-field ua-table-compra text-center" style="flex:1 1 100%;">

                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="tblProductos">
                        <thead class="table-light">
                            <tr>
                                <th style="width:50%">Producto*</th>
                                <th style="width:22%">Imagen</th>
                                <th class="text-center" style="width:16%">Cantidad*</th>
                                <th style="width:12%" class="text-center">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="tblBody">
                            @* Render inicial con índices explícitos *@
                            @for (int i = 0; i < Model.Lineas.Count; i++)
                            {
                                <tr>
                                    <input type="hidden" name="Lineas.Index" value="@i" />
                                    <!-- Producto -->
                                    <td>
                                        <select name="Lineas[@i].ProductoId"
                                                class="form-control producto js-prod"
                                                data-row="@i" required>
                                            <option value=""> Seleccione ↓ </option>
                                            @foreach (var pr in ViewBag.Productos as SelectList)
                                            {
                                                <option value="@pr.Value">@pr.Text</option>
                                            }
                                        </select>
                                    </td>

                                    <!-- Imagen -->
                                    <td>
                                        <img class="img-thumbnail js-prod-img ua-img-thumb-fila" data-row="@i"
                                             src="" alt="N"/>
                                    </td>

                                    <!-- Cantidad -->
                                    <td class="text-end">
                                        <input name="Lineas[@i].Cantidad" type="number" min="1"
                                               class="form-control cantidad text-end" required />
                                    </td>

                                    <!-- Eliminar fila -->
                                    <td class="text-center">
                                        <button type="button" class="btn-eliminate" onclick="eliminarFila(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="text-center">
                    <button type="button" class="btn-agregate" onclick="agregarFila()">
                        <i class="bi bi-plus-circle"></i> Agregar producto
                    </button>
                </div>
            </div>
        </div>

        <!-- ==============================
             ACCIONES (UA) – Cancelar / Guardar
             ============================== -->
        <div class="ua-actions">
            <a class="btn-cancel js-leave" asp-action="Index" asp-controller="Compras">
                <i class="bi bi-x-circle"></i> <span>Cancelar</span>
            </a>
            <button id="btnGuardar" type="submit" class="btn-save" disabled>
                <i class="bi bi-save"></i> <span>Guardar</span>
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // =========================
        // Catálogo productos (id, nombre, imagen) para preview
        // =========================
        const CAT = @Html.Raw(productosJson);   // [{id,nombre,imagen}, ...]
        const IDX = {}; CAT.forEach(p => { IDX[p.id] = p; });

        // (Ya no usaremos la plantilla estática; reconstruimos opciones dinámicamente)
        // const productosOptionsHtml = `...`;

        // ===== Helpers DOM =====
        function qsAll(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
        function getAllProductSelects(){ return qsAll('#tblBody select[name*=".ProductoId"]'); }

        // Conjunto de IDs actualmente seleccionados (no vacíos)
        function selectedIds(){
            const set = new Set();
            getAllProductSelects().forEach(s => { const v=(s.value||'').trim(); if (v) set.add(v); });
            return set;
        }

        // Construye HTML de <option> excluyendo IDs usados por otras filas.
        // Mantiene "current" para no dejar un select sin su valor actual.
        function buildOptionsHtml(exclude, current){
            let html = `<option value="">Seleccione ↓</option>`;
            for (const p of CAT){
                if (p.id !== current && exclude.has(p.id)) continue;   // fuera si otro ya lo usa
                html += `<option value="${p.id}" ${p.id===current?'selected':''}>${p.nombre}</option>`;
            }
            return html;
        }

        // Reconstruye TODOS los selects para reflejar los usados y evitar duplicados
        function refreshAllSelects(){
          const selects = getAllProductSelects();
          const chosen  = selectedIds();

          selects.forEach(sel => {
            const current = (sel.value||'').trim();
            const exclude = new Set(chosen); exclude.delete(current);
            if (sel.tomselect) sel.tomselect.destroy();
            sel.innerHTML = buildOptionsHtml(exclude, current);
            tsInitOne(sel);
          });

          // Recalcular previews
          selects.forEach(sel => onProductoChange.call(sel));

          evalReadyCreate();
        }


        let nextIndex = @Model.Lineas.Count;

        // =========================
        // Agregar fila (Producto + Imagen + Cantidad)
        // =========================
        function agregarFila() {
            const tbody = document.getElementById("tblBody");
            const i = nextIndex++;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <input type="hidden" name="Lineas.Index" value="${i}" />
                <td>
                    <select name="Lineas[${i}].ProductoId"
                            class="form-control producto js-prod" data-row="${i}" required></select>
                </td>
                <td>
                    <img class="img-thumbnail js-prod-img ua-img-thumb-fila" data-row="${i}"
                         src="" alt="N"/>
                </td>
                <td class="text-end">
                    <input name="Lineas[${i}].Cantidad" type="number" min="1"
                           class="form-control cantidad text-end" required />
                </td>
                <td class="text-center">
                    <button type="button" class="btn-eliminate" onclick="eliminarFila(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>`;
            tbody.appendChild(tr);

            // Armar opciones excluyendo lo ya seleccionado en otras filas
            const sel = tr.querySelector('.js-prod');
            const exclude = selectedIds();
            sel.innerHTML = buildOptionsHtml(exclude, "");
            sel.value = "";                            
            tsInitOne(sel);
                    sel.addEventListener('change', function(){
                onProductoChange.call(this);
                refreshAllSelects(); // sincroniza el resto
            });

            refreshAllSelects();      // sincroniza todos los selects
            evalReadyCreate();        // habilitar/disable Guardar
        }

        // =========================
        // Eliminar fila
        // =========================
        function eliminarFila(btn) {
            const fila = btn.closest("tr");
            fila.remove();
            refreshAllSelects();  // libera el producto eliminado en demás combos
            evalReadyCreate();
        }

        // =========================
        // Cambio de producto => setear imagen y nombre visibles
        // =========================
        function onProductoChange() {
            const row = this.getAttribute('data-row');
            const prodId = this.value || '';
            const info = IDX[prodId];

            const img  = document.querySelector(`.js-prod-img[data-row="${row}"]`);
            const name = document.querySelector(`.js-prod-name[data-row="${row}"]`);

            if (info) {
                if (img)  img.src = info.imagen || '';
                if (name) name.textContent = info.nombre || '';
            } else {
                if (img)  img.src = '';
                if (name) name.textContent = '';
            }
        }

        // Inicializar listeners para filas renderizadas por Razor
        document.querySelectorAll('.js-prod').forEach(sel => {
            sel.addEventListener('change', function(){
                onProductoChange.call(this);
                refreshAllSelects();
            });
            if (sel.value) onProductoChange.call(sel);
        });

        // =========================
        // Habilitar "Guardar" si:
        //  - Proveedor seleccionado
        //  - Al menos una línea con Producto y Cantidad > 0
        //  - (implícito) sin duplicados por refreshAllSelects()
        // =========================
        function evalReadyCreate() {
            const btn  = document.getElementById('btnGuardar');
            const form = document.getElementById('frmCompra');

            // Proveedor
            const proveedorId = (document.getElementById('ProveedorId')?.value || '').trim();

            // Al menos una línea válida
            const filas = Array.from(document.querySelectorAll('#tblBody tr'));
            let hayLinea = false;
            for (const tr of filas) {
                const prod = tr.querySelector('select[name*=".ProductoId"]');
                const cant = tr.querySelector('input[name*=".Cantidad"]');
                const vProd = (prod?.value || '').trim();
                const vCant = parseInt(cant?.value ?? '0', 10);
                if (vProd && !isNaN(vCant) && vCant > 0) { hayLinea = true; break; }
            }

            // Con refreshAllSelects no debería haber duplicados,
            // pero mantenemos la comprobación por robustez.
            const vals = getAllProductSelects().map(s => (s.value||'').trim()).filter(Boolean);
            const sinDuplicados = (new Set(vals).size === vals.length);

            const valid  = (proveedorId.length > 0) && hayLinea && sinDuplicados && (form ? form.checkValidity() : true);

            if (!btn) return;
            btn.disabled = !valid;
            btn.classList.toggle('enabled', valid);
        }

        // Eventos globales para reevaluar "Guardar"
        document.addEventListener('input', (e) => { if (e.target.closest('#frmCompra')) evalReadyCreate(); });
        document.addEventListener('change', (e) => { if (e.target.closest('#frmCompra')) evalReadyCreate(); });

        // Primera sincronización al cargar
        document.addEventListener('DOMContentLoaded', function(){
            refreshAllSelects();
            evalReadyCreate();
        });

        // =========================
        // PRG: prevenir doble submit
        // =========================
        (function () {
            const frm = document.getElementById('frmCompra');
            const btn = document.getElementById('btnGuardar');
            if (!frm || !btn) return;
            frm.addEventListener('submit', function () {
                btn.disabled = true; btn.classList.remove('enabled');
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
            });
        })();

        // =========================
        // SweetAlert2 
        // =========================
        (function () {
            const title    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SwalTitle"] as string ?? ""));
            const htmlText = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SwalText"] as string ?? ""));
            const urlIndex = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SwalIndexUrl"] as string ?? ""));
            const urlNew   = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SwalCreateUrl"] as string ?? ""));

            if (!title && !htmlText) return;

            Swal.fire({
                icon: 'success',
                title: title || 'Acción realizada',
                html: htmlText || '',
                showDenyButton: true,
                confirmButtonText: 'Volver al listado',
                denyButtonText: 'Crear otra',
                allowOutsideClick: false,
                allowEscapeKey: false,
                allowEnterKey: false
            }).then(r => {
                if (r.isConfirmed && urlIndex) window.location.href = urlIndex;
                else if (r.isDenied && urlNew)  window.location.href = urlNew;
            });
        })();

                /* ========= Mejora de selects con búsqueda (Tom Select) ========= */
        function tsInitOne(el){
            if (!el || el.tomselect) return;
            new TomSelect(el, {
                create: false,
                allowEmptyOption: true,
                closeAfterSelect: true,
                maxOptions: 5000,
                sortField: { field: 'text', direction: 'asc' },
                dropdownParent: 'body',
                placeholder: (el.getAttribute('placeholder') || 'Seleccione ↓')
            });
        }

        function tsInitAll(){
            // Proveedor (id estándar asp-for="ProveedorId")
            var prov = document.getElementById('ProveedorId');
            tsInitOne(prov);

            // Todos los selects de producto de las líneas
            document.querySelectorAll('#tblBody select[name*=".ProductoId"], #tbBody select[name*=".ProductoId"]').forEach(tsInitOne);
        }

        // Si tu código anti-duplicados rehace innerHTML, hay que re-inicializar Tom Select
        function tsRebuild(el){
            if (!el) return;
            if (el.tomselect) {
                el.tomselect.destroy();
            }
            tsInitOne(el);
        }

        // Llama esto DESPUÉS de cualquier cambio que altere las <option> (por ejemplo, refreshAllSelects)
        function tsRefreshAll(){
            // Proveedor
            var prov = document.getElementById('ProveedorId');
            if (prov) tsRebuild(prov);

            // Productos
            document.querySelectorAll('#tblBody select[name*=".ProductoId"], #tbBody select[name*=".ProductoId"]').forEach(tsRebuild);
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', tsInitAll);
    </script>
}

