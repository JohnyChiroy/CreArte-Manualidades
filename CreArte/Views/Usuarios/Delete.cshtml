@* ===============================================
   RUTA: Views/Usuarios/Delete.cshtml
   DESCRIPCIÓN: Confirmación de borrado lógico de USUARIO.
   - Muestra resumen del usuario (ID, Usuario, Rol, Empleado, Correo, Fecha, Estado)
   - Advierte que es borrado lógico (ELIMINADO = 1)
   - Exige confirmar escribiendo el nombre de usuario para habilitar "Eliminar"
   - POST apunta a Usuarios/Delete (HttpPost, ActionName("Delete"))
   =============================================== *@
@model CreArte.Models.USUARIO
@{
    ViewData["Title"] = "Eliminar Usuario";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Armar nombre completo del empleado (6 partes) si está disponible
    string FullName6(string? n1, string? n2, string? n3, string? a1, string? a2, string? ac)
    {
        var parts = new List<string>(6);
        if (!string.IsNullOrWhiteSpace(n1)) parts.Add(n1.Trim());
        if (!string.IsNullOrWhiteSpace(n2)) parts.Add(n2.Trim());
        if (!string.IsNullOrWhiteSpace(n3)) parts.Add(n3.Trim());
        if (!string.IsNullOrWhiteSpace(a1)) parts.Add(a1.Trim());
        if (!string.IsNullOrWhiteSpace(a2)) parts.Add(a2.Trim());
        if (!string.IsNullOrWhiteSpace(ac)) parts.Add(ac.Trim());
        return string.Join(" ", parts);
    }

    var persona = Model?.EMPLEADO?.EMPLEADONavigation;
    var empleadoNombre = persona == null
        ? "-"
        : FullName6(persona.PERSONA_PRIMERNOMBRE, persona.PERSONA_SEGUNDONOMBRE, persona.PERSONA_TERCERNOMBRE,
                    persona.PERSONA_PRIMERAPELLIDO, persona.PERSONA_SEGUNDOAPELLIDO, persona.PERSONA_APELLIDOCASADA);
}

<div class="ua-card">
    <h2 style="margin:0 0 12px 0;">Eliminar Usuario</h2>

    <!-- Aviso -->
    <div class="alert alert-warning" role="alert" style="display:flex; gap:8px; align-items:flex-start;">
        <i class="bi bi-exclamation-triangle-fill" style="font-size:1.2rem;"></i>
        <div>
            <strong>Este proceso realizará un borrado lógico.</strong>
            <div>El registro no se elimina físicamente; se marcará como <code>ELIMINADO = 1</code> y quedará fuera de los listados.</div>
        </div>
    </div>

    <!-- Resumen (solo lectura) -->
    <div class="ua-row">
        <div class="ua-field">
            <div class="ua-kv">
                <label><strong>Código Usuario:</strong></label>
                <input class="form-control" value="@Model.USUARIO_ID" readonly />
            </div>
        </div>
        <div class="ua-field">
            <div class="ua-kv">
                <label><strong>Estado:</strong></label>
                <span class="ua-pill@(Model.ESTADO ? " active" : "")">
                    @(Model.ESTADO ? "Activo" : "Inactivo")
                </span>
            </div>
        </div>
    </div>

    <div class="ua-row" style="margin-top:8px;">
        <div class="ua-field">
            <label><strong>Usuario:</strong></label>
            <input class="form-control" value="@Model.USUARIO_NOMBRE" readonly />
        </div>
        <div class="ua-field">
            <label><strong>Correo:</strong></label>
            <input class="form-control" value="@(Model.USUARIO_CORREO ?? "")" readonly />
        </div>
    </div>

    <div class="ua-row" style="margin-top:8px;">
        <div class="ua-field">
            <label><strong>Rol:</strong></label>
            <input class="form-control" value="@($"{Model.ROL?.ROL_NOMBRE} ({Model.ROL_ID})")" readonly />
        </div>
        <div class="ua-field">
            <label><strong>Empleado asignado:</strong></label>
            <input class="form-control" value="@($"{empleadoNombre} ({Model.EMPLEADO_ID})")" readonly />
        </div>
    </div>

    <div class="ua-row" style="margin-top:8px;">
        <div class="ua-field">
            <label><strong>Fecha de registro:</strong></label>
            <input class="form-control" value="@Model.USUARIO_FECHAREGISTRO.ToString("dd/MM/yyyy HH:mm")" readonly />
        </div>
        <div class="ua-field">
            <label><strong>Cambio inicial requerido:</strong></label>
            <input class="form-control" value="@(Model.USUARIO_CAMBIOINICIAL ? "Sí" : "No")" readonly />
        </div>
    </div>

    <!-- Confirmación -->
    <div class="ua-field" style="margin-top:12px;">
        <label for="txtConfirm"><strong>Para confirmar, escriba el nombre de usuario exactamente:</strong></label>
        <input id="txtConfirm" class="form-control" placeholder="@Model.USUARIO_NOMBRE" autocomplete="off" />
        <small class="text-muted">Debe coincidir con <code>@Model.USUARIO_NOMBRE</code>.</small>
    </div>

    <!-- Formulario POST (Delete) -->
    <form asp-action="Delete" asp-controller="Usuarios" asp-route-id="@Model.USUARIO_ID"
          method="post" id="frmDelete" style="margin-top:12px;">
        @Html.AntiForgeryToken()

        <!-- Enviar el ID en hidden (aunque ya va en ruta) -->
        <input type="hidden" name="USUARIO_ID" value="@Model.USUARIO_ID" />

        <div class="ua-actions">
            <a class="btn-cancel js-leave" asp-action="Index" asp-controller="Usuarios">
                <i class="bi bi-arrow-left"></i> <span>Cancelar</span>
            </a>
            <button id="btnEliminar" type="submit" class="btn-danger" disabled>
                <i class="bi bi-trash3"></i> <span>Eliminar</span>
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        /* =====================================================
           Habilita el botón Eliminar solo si coincide el usuario
           ===================================================== */
        (function(){
            const txt = document.getElementById('txtConfirm');
            const btn = document.getElementById('btnEliminar');
            const must = '@Model.USUARIO_NOMBRE';

            function ready(){
                const ok = (txt.value || '').trim() === must;
                btn.disabled = !ok;
                btn.classList.toggle('enabled', ok);
            }
            if (txt) txt.addEventListener('input', ready);
            ready();
        })();

        /* =====================================================
           Prevenir doble submit + feedback visual
           ===================================================== */
        (function(){
            const frm = document.getElementById('frmDelete');
            const btn = document.getElementById('btnEliminar');
            if (!frm || !btn) return;
            frm.addEventListener('submit', function(){
                btn.disabled = true;
                btn.classList.remove('enabled');
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Eliminando...';
            });
        })();
    </script>
}
