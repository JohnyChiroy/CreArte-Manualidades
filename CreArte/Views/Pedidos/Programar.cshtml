@model CreArte.ModelsPartial.ProduccionProgramarVM
@{
    ViewData["Title"] = "Programar producción";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="ua-card">
    <div class="ua-toolbar">
        <h2 class="m-0">Programar producción — Pedido @Model.PedidoId</h2>
    </div>

    <form asp-action="Programar" asp-controller="Pedidos" asp-route-id="@Model.PedidoId"
          method="post" id="frmProgramar" autocomplete="off">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="PedidoId" />

        <div class="ua-row" style="margin-top:12px;">
            <div class="ua-field">
                <label for="FechaInicio"><strong>Fecha inicio*</strong></label>
                <input asp-for="FechaInicio" type="date" class="form-control" id="FechaInicio" required />
                <span asp-validation-for="FechaInicio" class="text-danger"></span>
            </div>

            <div class="ua-field">
                <label for="FechaFin"><strong>Fecha fin*</strong></label>
                <input asp-for="FechaFin" type="date" class="form-control" id="FechaFin" required />
                <span asp-validation-for="FechaFin" class="text-danger"></span>
            </div>

            <div class="ua-field" style="flex:1">
                <label><strong>Notas</strong> <small class="text-muted">(opcional)</small></label>
                <input name="NotasPlan" class="form-control" maxlength="250"
                       placeholder="Información adicional para el plan (ej. recursos, prioridad, etc.)" />
            </div>
        </div>

        <div class="text-muted" style="margin-top:6px;">
            • La fecha fin no puede ser anterior a la fecha inicio.
            • Al programar, el pedido pasará a <b>PROGRAMADO</b>.
        </div>

        <div class="ua-actions" style="margin-top:14px;">
            <a class="btn-cancel" href="@Url.Action("Edit", "Pedidos", new { id = Model.PedidoId })">
                <i class="bi bi-x-circle"></i> <span>Cancelar</span>
            </a>
            <button id="btnProgramar" type="submit" class="btn-save">
                <i class="bi bi-calendar-check"></i> <span>Programar</span>
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const frm = document.getElementById('frmProgramar');
        const btn = document.getElementById('btnProgramar');

        function valFechas(){
            const i = new Date(document.getElementById('FechaInicio').value);
            const f = new Date(document.getElementById('FechaFin').value);
            if (isNaN(i.getTime()) || isNaN(f.getTime())) return false;
            return f.getTime() >= i.getTime();
        }

        frm.addEventListener('submit', function(e){
            if (!valFechas()){
                e.preventDefault();
                Swal.fire({ icon:'warning', title:'Rango inválido', text:'La fecha fin debe ser mayor o igual a la fecha inicio.' });
                return;
            }
            // UX anti-doble submit
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Programando…';
        });

        // (Opcional) fijar mínimo hoy
        const today = new Date().toISOString().slice(0,10);
        document.getElementById('FechaInicio').setAttribute('min', today);
        document.getElementById('FechaFin').setAttribute('min', today);
    </script>
}
