@using CreArte.ModelsPartial
@model VentaCreateEditVM

@{
    ViewData["Title"] = "Nueva Venta";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var productosJson = ViewBag.ProductosJson as string ?? "[]";
    var metodosPago = ViewBag.MetodosPagoCombo as List<SelectListItem> ?? new List<SelectListItem>();
}

@section Styles {
    <style>
        .ua-img-thumb-fila {
            width: 60px;
            height: 60px;
            object-fit: contain;
            object-position: center;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        /* Solo estética ligera del bloque de vuelto (no cambia tu tema) */
        .ua-kv {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
}

<div class="ua-card">
    <h2 style="margin:0 0 12px 0;">Registrar Nueva Venta</h2>

    <!-- ========================= FORMULARIO ========================= -->
    <form asp-action="Create" asp-controller="Ventas" method="post" id="frmVenta" autocomplete="off">
        @Html.AntiForgeryToken()

        <div asp-validation-summary="ModelOnly" class="text-danger validation-summary-errors"></div>

        <!-- 🔒 Campos ocultos llenados desde el modal -->
        <input type="hidden" asp-for="MetodoPagoId" id="hdMetodoPagoId" />
        <input type="hidden" asp-for="MontoPago" id="hdMontoPago" />

        <!-- ========================= ENCABEZADO ========================= -->
        <div class="ua-row">
            <div class="ua-field" style="flex:1;">
                <label asp-for="ClienteId"><strong>Cliente:*</strong></label>
                <select asp-for="ClienteId" class="form-control" id="ClienteId" required>
                    <option value="">Seleccione ↓</option>
                    @foreach (var c in Model.ClientesCombo)
                    {
                        <option value="@c.Value">@c.Text</option>
                    }
                </select>
                <span asp-validation-for="ClienteId" class="text-danger"></span>

                <label asp-for="UsuarioId"><strong>Vendedor:*</strong></label>
                <select asp-for="UsuarioId" class="form-control" id="UsuarioId" required>
                    <option value="">Seleccione ↓</option>
                    @foreach (var u in ViewBag.UsuariosCombo as List<SelectListItem>)
                    {
                        <option value="@u.Value">@u.Text</option>
                    }
                </select>
                <span asp-validation-for="UsuarioId" class="text-danger"></span>
            </div>
        </div>

        <!-- ========================= DETALLE DE VENTA ========================= -->
        <div style="margin-top:12px;">
            <div class="ua-field ua-table-compra text-center" style="flex:1 1 100%;">
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="tblProductos">
                        <thead class="table-light">
                            <tr>
                                <th style="width:36%">Producto*</th>
                                <th style="width:16%">Imagen</th>
                                <th style="width:12%" class="text-center">Cantidad*</th>
                                <th style="width:14%" class="text-end">Precio venta*</th>
                                <th style="width:14%" class="text-end">Subtotal</th>
                                <th style="width:8%" class="text-center">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="tblBody">
                            @for (int i = 0; i < Model.Detalles.Count; i++)
                            {
                                <tr>
                                    <input type="hidden" name="Detalles.Index" value="@i" />
                                    <input type="hidden" name="Detalles[@i].InventarioId" class="js-inv" data-row="@i" />
                                    <input type="hidden" name="Detalles[@i].ProductoId" class="js-prod-id" data-row="@i" />

                                    <td>
                                        <select name="Detalles[@i].InventarioId"
                                                class="form-control producto js-prod"
                                                data-row="@i" required>
                                            <option value="">Seleccione ↓</option>
                                        </select>
                                    </td>
                                    <td><img class="img-thumbnail js-prod-img ua-img-thumb-fila" data-row="@i" src="" alt="N" /></td>
                                    <td class="text-end">
                                        <input name="Detalles[@i].Cantidad" type="number" min="1" step="1"
                                               class="form-control cantidad text-end js-cant" required />
                                    </td>
                                    <td class="text-end">
                                        <input name="Detalles[@i].PrecioUnitario" type="number" min="0" step="0.01"
                                               class="form-control precio text-end js-precio" required />
                                    </td>
                                    <td class="text-end">
                                        <input name="Detalles[@i].NombreProducto" type="hidden" class="js-prod-name" data-row="@i" />
                                        <span class="js-subtotal" data-row="@i">Q 0.00</span>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn-eliminate" onclick="eliminarFila(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" class="text-center">
                                    <button type="button" class="btn-agregate" onclick="agregarFila()">
                                        <i class="bi bi-plus-circle"></i> Agregar producto
                                    </button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Totales -->
                <div class="d-flex justify-content-end mt-3">
                    <div style="min-width:280px;">
                        <div class="d-flex justify-content-between">
                            <strong>Total venta:</strong>
                            <strong id="lblTotal">Q 0.00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================= ACCIONES ========================= -->
        <div class="ua-actions">
            <a class="btn-cancel js-leave" href="@Url.Action("Index", "Ventas")" id="btnCancelar">
                <i class="bi bi-x-circle"></i> <span>Cancelar</span>
            </a>
            <button id="btnGuardar" type="submit" class="btn-save" disabled>
                <i class="bi bi-save"></i> <span>Registrar Venta</span>
            </button>
        </div>
    </form>
</div>

<!-- ========================= MODAL DE PAGO ========================= -->
<div class="modal fade" id="pagoModal" tabindex="-1" aria-labelledby="pagoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pagoModalLabel">Registrar pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label for="mpMetodo"><strong>Método de pago</strong></label>
                    <select id="mpMetodo" class="form-control" required>
                        <option value="">Seleccione ↓</option>
                        @foreach (var m in metodosPago)
                        {
                            <option value="@m.Value">@m.Text</option>
                        }
                    </select>
                    <div class="text-danger small d-none" id="mpMetodoErr">Seleccione el método de pago.</div>
                </div>

                <div class="mb-2">
                    <label for="mpMonto"><strong>Monto a cobrar</strong></label>
                    <input id="mpMonto" type="number" min="0.01" step="0.01" class="form-control" readonly />
                    <div class="text-danger small d-none" id="mpMontoErr">Monto inválido.</div>
                    <small class="text-muted">Es el total de la venta.</small>
                </div>

                <!-- Bloque de efectivo -->
                <div id="mpEfectivoBlock" class="border rounded p-2">
                    <div class="mb-2">
                        <label for="mpEfectivo"><strong>Efectivo recibido</strong></label>
                        <!-- ⇩ editable (sin disabled) -->
                        <input id="mpEfectivo" type="number" min="0.01" step="0.01" class="form-control" />
                        <div class="text-danger small d-none" id="mpEfectivoErr">
                            El efectivo recibido debe ser mayor o igual al monto a cobrar.
                        </div>
                    </div>

                    <div class="ua-kv">
                        <span><strong>Vuelto</strong></span>
                        <!-- ⇩ label (solo lectura) -->
                        <span id="mpVuelto" class="fw-bold">Q 0.00</span>
                    </div>
                </div>

                <div class="alert alert-info py-2 mt-2 mb-0">
                    Total actual: <strong id="mpTotalTexto">Q 0.00</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn-confirmado" id="btnConfirmarPago">
                    <i class="bi bi-cash-coin"></i> Confirmar pago
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const CAT = @Html.Raw(productosJson);
        const IDX = {}; CAT.forEach(p => { IDX[p.inventarioId] = p; });

        function qs(sel, root=document){ return root.querySelector(sel); }
        function qsAll(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
        function rowEl(el){ return el.closest('tr'); }
        function money(n){ return 'Q ' + (Number(n||0).toFixed(2)); }

        function getAllProductSelects(){ return qsAll('#tblBody select[name*=".InventarioId"]'); }
        function selectedIds(){
            const set = new Set();
            getAllProductSelects().forEach(s => { const v=(s.value||'').trim(); if(v) set.add(v); });
            return set;
        }
        function buildOptionsHtml(exclude, current){
            let html = `<option value="">Seleccione ↓</option>`;
            for (const p of CAT){
                if (p.inventarioId !== current && exclude.has(p.inventarioId)) continue;
                const stockTxt = (p.stock != null) ? ` (Stock: ${Number(p.stock)})` : '';
                html += `<option value="${p.inventarioId}" ${p.inventarioId===current?'selected':''}>${p.nombre}${stockTxt}</option>`;
            }
            return html;
        }
        function refreshAllSelects(){
            const selects = getAllProductSelects();
            const chosen = selectedIds();
            selects.forEach(sel => {
                const current = (sel.value||'').trim();
                const exclude = new Set(chosen); exclude.delete(current);
                sel.innerHTML = buildOptionsHtml(exclude, current);
            });
            selects.forEach(sel => onProductoChange.call(sel, true));
            recalcTotales();
            evalReady();
        }

        let nextIndex = @Model.Detalles.Count;
        function agregarFila(){
            const tbody = document.getElementById("tblBody");
            const i = nextIndex++;
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <input type="hidden" name="Detalles.Index" value="${i}" />
                <input type="hidden" name="Detalles[${i}].InventarioId" class="js-inv" data-row="${i}" />
                <input type="hidden" name="Detalles[${i}].ProductoId" class="js-prod-id" data-row="${i}" />
                <td><select name="Detalles[${i}].InventarioId" class="form-control producto js-prod" data-row="${i}" required></select></td>
                <td><img class="img-thumbnail js-prod-img ua-img-thumb-fila" data-row="${i}" src="" alt="N"/></td>
                <td class="text-end"><input name="Detalles[${i}].Cantidad" type="number" min="1" step="1" class="form-control cantidad text-end js-cant" required /></td>
                <td class="text-end"><input name="Detalles[${i}].PrecioUnitario" type="number" min="0" step="0.01" class="form-control precio text-end js-precio" required /></td>
                <td class="text-end"><input name="Detalles[${i}].NombreProducto" type="hidden" class="js-prod-name" data-row="${i}" /><span class="js-subtotal" data-row="${i}">Q 0.00</span></td>
                <td class="text-center"><button type="button" class="btn-eliminate" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>`;
            tbody.appendChild(tr);

            const sel = tr.querySelector('.js-prod');
            const exclude = selectedIds();
            sel.innerHTML = buildOptionsHtml(exclude, "");

            sel.addEventListener('change', function(){ onProductoChange.call(this); refreshAllSelects(); });
            tr.querySelector('.js-cant').addEventListener('input', recalcFila);
            tr.querySelector('.js-precio').addEventListener('input', recalcFila);

            refreshAllSelects();
            evalReady();
            changed = true;
        }
        function eliminarFila(btn){
            rowEl(btn).remove();
            refreshAllSelects();
            evalReady();
            changed = true;
        }

        function onProductoChange(noRecalc){
            const row = this.getAttribute('data-row');
            const invId = this.value || '';
            const info = IDX[invId];
            const img = qs(`.js-prod-img[data-row="${row}"]`);
            const name = qs(`input.js-prod-name[data-row="${row}"]`);
            const inv = qs(`input.js-inv[data-row="${row}"]`);
            const prod = qs(`input.js-prod-id[data-row="${row}"]`);
            const precio = rowEl(this).querySelector('.js-precio');

            if(info){
                if(img) img.src = info.imagen || '';
                if(name) name.value = info.nombre || '';
                if(inv) inv.value = info.inventarioId || '';
                if(prod) prod.value = info.productoId || '';
                if(precio){
                    const pv = Number(info.precioVenta || 0);
                    if(!Number(precio.value)) precio.value = pv.toFixed(2);
                    precio.title = `Precio: Q ${pv.toFixed(2)} | Stock: ${info.stock}`;
                }
            }else{
                if(img) img.src = '';
                ifname && (name.value = '');
                if(inv) inv.value = '';
                if(prod) prod.value = '';
                if(precio) precio.title = '';
            }
            if(!noRecalc) recalcFila.call(this);
            changed = true;
        }

        function recalcFila(){
            const tr = rowEl(this);
            const c = Number(tr.querySelector('.js-cant')?.value || 0);
            const p = Number(tr.querySelector('.js-precio')?.value || 0);
            const sub = Math.round((c * p) * 100) / 100;
            tr.querySelector('.js-subtotal').textContent = money(sub);
            recalcTotales();
            evalReady();
        }
        function recalcTotales(){
            let total = 0;
            qsAll('#tblBody tr').forEach(tr => {
                const c = Number(tr.querySelector('.js-cant')?.value || 0);
                const p = Number(tr.querySelector('.js-precio')?.value || 0);
                total += c * p;
            });
            qs('#lblTotal').textContent = money(total);
        }

        function evalReady(){
            const clienteOk = (qs('#ClienteId')?.value || '').trim();
            const usuarioOk = (qs('#UsuarioId')?.value || '').trim();
            const filas = qsAll('#tblBody tr');
            const ok = clienteOk && usuarioOk && filas.length > 0;
            qs('#btnGuardar').disabled = !ok;
        }

        document.addEventListener('DOMContentLoaded', function(){
            refreshAllSelects();
            recalcTotales();
            evalReady();
        });

        let changed = false;
        const frm = qs('#frmVenta');
        frm.addEventListener('input', ()=> changed = true);
        frm.addEventListener('change', ()=> changed = true);

        qs('#btnCancelar').addEventListener('click', function(e){
            if(!changed) return;
            e.preventDefault();
            Swal.fire({
                icon:'question', title:'¿Cancelar venta?', text:'Perderás los cambios no guardados.',
                showCancelButton:true, confirmButtonText:'Sí, salir', cancelButtonText:'Seguir aquí'
            }).then(r=>{ if(r.isConfirmed) window.location.href=this.href; });
        });

        // ======== INTERCEPTA SUBMIT -> CONFIRM -> MODAL DE PAGO ========
        let pagoModal;
        frm.addEventListener('submit', function(e){
            e.preventDefault();
            if(qs('#btnGuardar').disabled) return;

            const totalTxt = qs('#lblTotal').textContent || 'Q 0.00';
            const totalNum = Number(totalTxt.replace(/[^\d.]/g,'') || 0);

            Swal.fire({
                icon:'question', title:'¿Registrar venta?',
                html: totalTxt,
                showCancelButton:true, confirmButtonText:'Continuar y cobrar', cancelButtonText:'Revisar'
            }).then(r=>{
                if(!r.isConfirmed) return;

                const el = document.getElementById('pagoModal');
                pagoModal = pagoModal || new bootstrap.Modal(el, {backdrop:'static', keyboard:false});

                // precarga total en el modal (solo lectura)
                qs('#mpTotalTexto').textContent = money(totalNum);
                const mpMonto = qs('#mpMonto');
                if (mpMonto){
                    mpMonto.value = totalNum.toFixed(2);
                    mpMonto.readOnly = true; // monto no editable
                }

        // Default: Efectivo por valor o por texto
        const mpSel = qs('#mpMetodo');
        if (mpSel) {
            const opts = Array.from(mpSel.options);
            let idx = opts.findIndex(o => (o.value || '').trim().toUpperCase() === 'EFECTIVO');
            if (idx < 0) idx = opts.findIndex(o => (o.text || '').trim().toUpperCase().includes('EFECTIVO'));
            if (idx >= 0) mpSel.selectedIndex = idx;
        }

                // Inicializa bloque de efectivo y cálculos
                toggleEfectivoBlock();
                recalcVuelto();
                validatePago();

                // limpia errores
                qs('#mpMetodoErr')?.classList.add('d-none');
                qs('#mpMontoErr')?.classList.add('d-none');
                qs('#mpEfectivoErr')?.classList.add('d-none');

                pagoModal.show();
            });
        });

        // -------- Validación del modal (habilita/deshabilita botón) --------
        function validatePago(){
            const metodo = (qs('#mpMetodo')?.value || '').trim();
            const monto  = Number(qs('#mpMonto')?.value || 0);
            const total  = Number((qs('#lblTotal').textContent||'').replace(/[^\d.]/g,'') || 0);
            const btn    = qs('#btnConfirmarPago');

            let ok = true;

            // 🔹 Método de pago obligatorio
            if(!metodo){
                qs('#mpMetodoErr')?.classList.remove('d-none'); ok = false;
            } else {
                qs('#mpMetodoErr')?.classList.add('d-none');
            }

            // 🔹 Monto (total) válido
            if(!(monto > 0) || Math.abs(monto - total) > 0.01){
                qs('#mpMontoErr')?.classList.remove('d-none'); ok = false;
            } else {
                qs('#mpMontoErr')?.classList.add('d-none');
            }

            // 🔹 Si es EFECTIVO, validar recibido
            if (isMetodoEfectivo()){
                const rec = Number(qs('#mpEfectivo')?.value || 0);
                const err = qs('#mpEfectivoErr');
                if (!(rec > 0)) {
                    // campo vacío o 0 no permitido
                    err.textContent = "Debe ingresar el efectivo recibido.";
                    err.classList.remove('d-none');
                    ok = false;
                }
                else if (rec < total){
                    // monto menor al total
                    err.textContent = "El efectivo recibido no puede ser menor al monto a cobrar.";
                    err.classList.remove('d-none');
                    ok = false;
                }
                else {
                    err.classList.add('d-none');
                }
            } else {
                // no efectivo ⇒ ocultar error
                qs('#mpEfectivoErr')?.classList.add('d-none');
            }

            if (btn) btn.disabled = !ok;
            return ok;
        }

        // -------- Lógica de efectivo / vuelto --------
        function toggleEfectivoBlock(){
            const block = qs('#mpEfectivoBlock');
            const efectivo = qs('#mpEfectivo');
            const esEfec = isMetodoEfectivo();

            if (block){
                block.style.opacity = esEfec ? '1' : '0.6';
            }
            if (efectivo){
                efectivo.disabled = !esEfec;
                if (esEfec){
                    setTimeout(()=> efectivo.focus(), 50);
                } else {
                    efectivo.value = '';
                    qs('#mpVuelto').textContent = money(0);
                    qs('#mpEfectivoErr')?.classList.add('d-none');
                }
            }
            validatePago();
        }

        function recalcVuelto(){
            const total = Number((qs('#mpMonto')?.value || 0));
            const rec   = Number((qs('#mpEfectivo')?.value || 0));
            const vuelto = Math.max(0, rec - total);
            qs('#mpVuelto').textContent = money(vuelto);
            validatePago();
        }

        function isMetodoEfectivo(){
            const sel = qs('#mpMetodo');
            const val = (sel?.value || '').trim().toUpperCase();
            const txt = (sel?.selectedOptions?.[0]?.text || '').trim().toUpperCase();
            return val === 'EFECTIVO' || txt.includes('EFECTIVO'); // valor o texto
        }

        document.getElementById('mpMetodo')?.addEventListener('change', toggleEfectivoBlock);
        document.getElementById('mpEfectivo')?.addEventListener('input', recalcVuelto);

        // Confirmar pago en el modal
        document.getElementById('btnConfirmarPago').addEventListener('click', function(){
            if (!validatePago()) return;

            const metodo = (qs('#mpMetodo')?.value || '').trim();
            const monto  = Number(qs('#mpMonto')?.value || 0);

            // Inyectar hidden y enviar
            qs('#hdMetodoPagoId').value = metodo;
            qs('#hdMontoPago').value = monto.toFixed(2);

            pagoModal?.hide();
            const btn=qs('#btnGuardar');
            btn.disabled=true; btn.innerHTML='<i class="bi bi-hourglass-split"></i> Guardando...';
            frm.submit();
        });

        (function(){
            const ok='@(TempData["ok"] ?? "")';
            const err='@(TempData["error"] ?? "")';
            if(ok) Swal.fire({icon:'success',title:ok,timer:2500,showConfirmButton:false});
            if(err) Swal.fire({icon:'error',title:err,timer:2800,showConfirmButton:false});
        })();

    </script>
}
