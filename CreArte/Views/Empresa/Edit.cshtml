@* ===============================================
   RUTA: Views/Empresa/Edit.cshtml
   DESCRIPCIÓN:
   - Formulario de REGISTRO/EDICIÓN de EMPRESA (Single Settings Page).
   - Mismos estilos que Empleados (ua-card, ua-row, ua-field, ua-pill, ua-actions).
   - Arreglo del "beforeunload": NO bloquea cuando haces submit.
   - Preview de logo y habilitación de botón Guardar.
   =============================================== *@
@model CreArte.ModelsPartial.EmpresaConfigVM
@{
    ViewData["Title"] = "Editar Empresa";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="ua-card">
    <h2 style="margin:0 0 12px 0;">
        @(string.IsNullOrWhiteSpace(Model.USUARIO_CREACION) ? "Registrar Empresa" : "Editar Empresa")
    </h2>

    <!-- IMPORTANTE:
         - id="frmEmpresa" y id="btnGuardar" se usan en el script.
         - data-guard="true" activa el guard de cambios no guardados.
    -->
    <form asp-action="Edit" asp-controller="Empresa" method="post"
          enctype="multipart/form-data" id="frmEmpresa" data-guard="true" autocomplete="off">
        @Html.AntiForgeryToken()

        <div asp-validation-summary="ModelOnly" class="text-danger validation-summary-errors"></div>

        <!-- Fila superior: Código + Estado -->
        <div class="ua-row">
            <div class="ua-field">
                <div class="ua-kv">
                    <label asp-for="EMPRESA_ID"><strong>Código Empresa:</strong></label>
                    <input asp-for="EMPRESA_ID" class="form-control" readonly />
                </div>
                <span class="ua-help">Código no editable.</span>
                <span asp-validation-for="EMPRESA_ID" class="text-danger"></span>
            </div>

            <div class="ua-field">
                <div class="ua-kv">
                    <label><strong>Estado:</strong></label>
                    <span id="pillEstado" class="ua-pill@(Model?.ESTADO == true ? " active" : "")">
                        @(Model?.ESTADO == true ? "Activo" : "Inactivo")
                    </span>
                </div>
                <div class="ua-switch" style="margin-top:2px;">
                    <input asp-for="ESTADO" type="checkbox" id="chkEstado" />
                    <span>Activo</span>
                </div>
                <span asp-validation-for="ESTADO" class="text-danger"></span>
            </div>
        </div>

        @* ==============================
           Datos principales
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field" style="flex:1 1 60%;">
                <label asp-for="NOMBRE_COMERCIAL_EMPRESA"><strong>Nombre Comercial:*</strong></label>
                <input asp-for="NOMBRE_COMERCIAL_EMPRESA" class="form-control" maxlength="200" required />
                <span asp-validation-for="NOMBRE_COMERCIAL_EMPRESA" class="text-danger"></span>
            </div>
            <div class="ua-field" style="flex:1 1 40%;">
                <label asp-for="NOMBRE_LEGAL_EMPRESA"><strong>Nombre Legal:</strong></label>
                <input asp-for="NOMBRE_LEGAL_EMPRESA" class="form-control" maxlength="100" />
                <span asp-validation-for="NOMBRE_LEGAL_EMPRESA" class="text-danger"></span>
            </div>
        </div>

        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label asp-for="NIT_EMPRESA"><strong>NIT:</strong></label>
                <input asp-for="NIT_EMPRESA" class="form-control" maxlength="20" />
                <span asp-validation-for="NIT_EMPRESA" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="CORREO_EMPRESA"><strong>Correo:</strong></label>
                <input asp-for="CORREO_EMPRESA" type="email" class="form-control" maxlength="100" />
                <span asp-validation-for="CORREO_EMPRESA" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="TELEFONO_EMPRESA"><strong>Teléfono (8 dígitos):*</strong></label>
                <input asp-for="TELEFONO_EMPRESA" class="form-control" maxlength="8" required />
                <span asp-validation-for="TELEFONO_EMPRESA" class="text-danger"></span>
            </div>
            <div class="ua-field">
                <label asp-for="WHATSAPP_EMPRESA"><strong>WhatsApp (8 dígitos):</strong></label>
                <input asp-for="WHATSAPP_EMPRESA" class="form-control" maxlength="8" />
                <span asp-validation-for="WHATSAPP_EMPRESA" class="text-danger"></span>
            </div>
        </div>

        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field" style="flex:1 1 100%;">
                <label asp-for="DIRECCION_EMPRESA"><strong>Dirección:*</strong></label>
                <input asp-for="DIRECCION_EMPRESA" class="form-control" maxlength="300" required />
                <span asp-validation-for="DIRECCION_EMPRESA" class="text-danger"></span>
            </div>
        </div>

        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field" style="flex:1 1 100%;">
                <label asp-for="DESCRIPCION_EMPRESA"><strong>Descripción corta:</strong></label>
                <input asp-for="DESCRIPCION_EMPRESA" class="form-control" maxlength="30" />
                <span asp-validation-for="DESCRIPCION_EMPRESA" class="text-danger"></span>
            </div>
        </div>

        @* ==============================
           Logo (preview + carga)
           ============================== *@
        <div class="ua-row" style="margin-top:8px;">
            <div class="ua-field">
                <label class="form-label"><strong>Logo actual:</strong></label>
                <div class="p-2 border rounded d-flex align-items-center" style="gap:12px;">
                    <img id="logoPreview"
                         src="@(string.IsNullOrWhiteSpace(Model.LOGO_EMPRESA) ? "/images/no-logo.png" : Model.LOGO_EMPRESA)"
                         alt="Logo" style="height:64px;width:auto;border-radius:6px;" />
                    <div class="ua-help">Vista previa del logo.</div>
                </div>
            </div>
            <div class="ua-field">
                <label asp-for="LogoFile"><strong>Cambiar logo:</strong></label>
                <input asp-for="LogoFile" type="file" accept="image/*" class="form-control" id="LogoFile" />
                <span class="ua-help">Se guardará en: /uploads/logos/</span>
            </div>
        </div>

        <!-- Acciones -->
        <div class="ua-actions">
            <a class="btn-cancel js-leave" asp-action="Index" asp-controller="Empresa">
                <i class="bi bi-x-circle"></i> <span>Cancelar</span>
            </a>
            <button id="btnGuardar" type="submit" class="btn-save" disabled>
                <i class="bi bi-save"></i> <span>Guardar</span>
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // ==========================================================
        // Pill Estado (mismo patrón que Empleados)
        // ==========================================================
        (function () {
            const chk = document.getElementById('chkEstado');
            const pill = document.getElementById('pillEstado');
            if (!chk || !pill) return;
            const syncPill = () => chk.checked ? (pill.classList.add('active'), pill.textContent='Activo')
                                               : (pill.classList.remove('active'), pill.textContent='Inactivo');
            chk.addEventListener('change', syncPill); syncPill();
        })();

        // ==========================================================
        // Preview instantáneo del logo
        // ==========================================================
        (function () {
            const input = document.getElementById('LogoFile');
            const preview = document.getElementById('logoPreview');
            if (!input || !preview) return;
            input.addEventListener('change', function () {
                const file = this.files && this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => preview.src = e.target.result;
                reader.readAsDataURL(file);
            });
        })();

        // ==========================================================
        // Habilitar botón Guardar (requeridos + checkValidity)
        // ==========================================================
        (function () {
            const btn  = document.getElementById('btnGuardar');
            const frm  = document.getElementById('frmEmpresa');
            const reqIds = ['NOMBRE_COMERCIAL_EMPRESA','DIRECCION_EMPRESA','TELEFONO_EMPRESA'];
            const els = reqIds.map(id => document.getElementById(id));
            function ready() {
                const baseOk = els.every(el => el && (el.value || '').trim().length > 0);
                const ok = baseOk && (frm ? frm.checkValidity() : true);
                if (!btn) return; btn.disabled = !ok; btn.classList.toggle('enabled', ok);
            }
            els.forEach(el => el && el.addEventListener('input', ready));
            if (frm) frm.addEventListener('change', ready);
            ready();
        })();

        // ==========================================================
        // GUARD CORREGIDO:
        // - Muestra "abandonar sitio" sólo si hay cambios y NO estamos guardando.
        // - Al hacer submit: desactiva el guard y evita doble submit.
        // ==========================================================
        (function () {
            const frm = document.getElementById('frmEmpresa');
            const btn = document.getElementById('btnGuardar');
            if (!frm || !btn) return;

            let isSubmitting = false; // <- clave para no disparar beforeunload al guardar
            let initialSnapshot = new URLSearchParams(new FormData(frm)).toString();

            function beforeUnloadHandler(e) {
                if (!frm.dataset.guard) return;
                if (isSubmitting) return; // si estamos guardando, NO mostrar alerta
                const current = new URLSearchParams(new FormData(frm)).toString();
                if (current !== initialSnapshot) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            }

            // Registrar guard
            window.addEventListener('beforeunload', beforeUnloadHandler);

            // Submit del formulario
            frm.addEventListener('submit', function (ev) {
                const currentSnapshot = new URLSearchParams(new FormData(frm)).toString();

                // Si NO hay cambios, avisamos y cancelamos submit
                if (currentSnapshot === initialSnapshot) {
                    ev.preventDefault();
                    if (window.Swal) {
                        Swal.fire({ icon:'info', title:'Sin cambios', text:'No se modificó ningún dato.' });
                    }
                    return false;
                }

                // Sí hay cambios y vamos a guardar:
                isSubmitting = true; // <- desactiva el beforeunload visualmente
                window.removeEventListener('beforeunload', beforeUnloadHandler);

                // Prevenir doble submit y feedback visual
                btn.disabled = true;
                btn.classList.remove('enabled');
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
            });
        })();

        // ==========================================================
        // PRG (post-guardar) con SweetAlert se maneja en Index.cshtml
        // (al redirigir con TempData["SwalTitle"/"SwalText"])
        // ==========================================================
    </script>
}
